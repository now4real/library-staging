!function i(o,r,s){function a(t,e){if(!r[t]){if(!o[t]){var n="function"==typeof require&&require;if(!e&&n)return n(t,!0);if(u)return u(t,!0);throw(e=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",e}n=r[t]={exports:{}},o[t][0].call(n.exports,function(e){return a(o[t][1][e]||e)},n,n.exports,i,o,r,s)}return r[t].exports}for(var u="function"==typeof require&&require,e=0;e<s.length;e++)a(s[e]);return a}({1:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});e=e(3);function i(){}i.MODULE_PREFIX="CORE",i.LOGGER_LEVEL=e.LoggerLevels.Warn,i.LEVEL_MAX_LENGTH=Number("5"),i.MODULE_MAX_LENGTH=Number("6"),i.CONF=void 0,i.CONF_SERIALIZED=void 0,i.TECHNICAL_CONF=void 0,i.SCRIPT_CONF=void 0,i.FELS_PROTOCOL="https",i.FELS_PORT="443",i.FELS_ADAPTER_SET="FELS",i.FELS_SHARING_NAME="n4rCommon",i.ENABLED_DOMAINS=["now4real.com","localhost:3000","localtest.me:3000"],i.SANDBOX_SITE_CONTEXT="shared-public-sandbox.test",i.LOCAL_PERSISTENCE=!0,i.MSG_MAX_LENGTH_DEFAULT=140,i.MSG_RESEND_PERIOD_DEFAULT=0,i.AUTH_WINDOW_CHECK_INTERVAL=1500,i.DISCONNECTION_GRACE_PERIOD=18e4,i.CHAT_SNAPSHOT_GRACE_PRERIOD=3e5,i.ORIGIN_VERIFICATION_TIMEOUT=15e3,i.JWT_RESOLVER_TIMEOUT=8e3,i.VISIBILITY_THROTTLING_PERIOD=1e3,i.BROWSER_PREFERENCES_MASTER_KEY="n4rSitePreferences",i.NO_RE_AUTH_KEY="noRe",i.NO_RE_AUTH_MASTER_KEY="noReMain",i.EMAIL_AUTH_KEY="email",i.EMAIL_AUTH_MASTER_KEY="emailMain",n.default=i},{3:3}],2:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.ERROR_LEVEL=n.WARN_LEVEL=n.INFO_LEVEL=n.DEBUG_LEVEL=void 0;e=e(3),n.DEBUG_LEVEL=e.LoggerLevels.Debug,n.INFO_LEVEL=e.LoggerLevels.Info,n.WARN_LEVEL=e.LoggerLevels.Warn,n.ERROR_LEVEL=e.LoggerLevels.Error,i.PRESENCE_FOREGROUND="presenceForeground",i.PRESENCE_TYPING="presenceTyping",i.MESSAGE_USER_LIST="messageUserList",i.EVENTS="events",i.KEY="key",i.COMMAND="command",i.ADD="ADD",i.UPDATE="UPDATE",i.DELETE="DELETE",i.HTTP="http",i.HTTPS="https",i.LOCALHOST="localhost",i.CONNECTED="CONNECTED",i.DISCONNECTED="DISCONNECTED",i.DISCONNECTED_WILL_RETRY="DISCONNECTED:WILL-RETRY",i.DISCONNECTED_TRYING_RECOVERY="DISCONNECTED:TRYING-RECOVERY",i.ERROR_CODE_PROP="code",i.ERROR_MESSAGE_PROP="message",i.ON="on",i.OFF="off",i.YES="yes",i.NO="no",i.PAGE="page",i.SITE="site",i.TAB="\t",i.SLASH="/",i.GLOBAL_SUB_SUFFIX="g.invalid",i.STORAGE_LOGIN_KEY="n4rAuth",i.STORAGE_CONTROL_LINK_KEY="n4rFels",i.G_TRANSLATE_DOMAIN="translate.goog",i.MODERATOR="MODERATOR",i.GUEST="GUEST",i.EMAIL="EMAIL",i.GROUP_PLACEHOLDER="group.invalid",i.MASTER_PLACEHOLDER="master.invalid",i.RESOLVE="resolve",i.REJECT="reject",i.SITE_CONFIGURATION_CHANGED="SITE_CONFIGURATION_CHANGED",i.SITE_NOT_ACTIVE="SITE_NOT_ACTIVE",e=i;function i(){}n.default=e},{3:3}],3:[function(e,t,n){var i;Object.defineProperty(n,"__esModule",{value:!0}),n.SharedEvent=n.ConnectMode=n.LSServerError=n.N4RServerError=n.RemoteFunctions=n.LoggerLevels=n.Social=void 0,(i=n.Social||(n.Social={}))[i.FACEBOOK=0]="FACEBOOK",i[i.GOOGLE=1]="GOOGLE",i[i.LINKEDIN=2]="LINKEDIN",i[i.TWITTER=3]="TWITTER",(i=n.LoggerLevels||(n.LoggerLevels={}))[i.Debug=1]="Debug",i[i.Info=2]="Info",i[i.Warn=3]="Warn",i[i.Error=4]="Error",i[i.Off=5]="Off",(i=n.RemoteFunctions||(n.RemoteFunctions={}))[i.MESSAGE_SEND=0]="MESSAGE_SEND",i[i.MESSAGE_DELETE=1]="MESSAGE_DELETE",i[i.CHAT_FLUSH=2]="CHAT_FLUSH",i[i.CHAT_ENABLE=3]="CHAT_ENABLE",i[i.MUTE_USER_GET=4]="MUTE_USER_GET",i[i.MUTE_USER_SET=5]="MUTE_USER_SET",i[i.DELETE_PASSWORD=6]="DELETE_PASSWORD",i[i.GET_AUTH_INFO=7]="GET_AUTH_INFO",i[i.REPORT_CHAT_MESSAGE=8]="REPORT_CHAT_MESSAGE",i[i.USER_PREFERENCE_SET=9]="USER_PREFERENCE_SET",i[i.LOG=10]="LOG",i[i.USER_CONSENT_SET=11]="USER_CONSENT_SET",i[i.JWT_REFRESH=12]="JWT_REFRESH",i[i.POLL_NEW=13]="POLL_NEW",i[i.POLL_CLOSE=14]="POLL_CLOSE",i[i.POLL_VOTE_SET=15]="POLL_VOTE_SET",i[i.POLL_VOTE_GET=16]="POLL_VOTE_GET",(i=n.N4RServerError||(n.N4RServerError={}))[i.Success=0]="Success",i[i.Generic=-1]="Generic",i[i.Unauthorized=-2]="Unauthorized",i[i.IllegalArgument=-3]="IllegalArgument",i[i.TemporarilyUnavailable=-4]="TemporarilyUnavailable",i[i.UnsupportedClient=-5]="UnsupportedClient",i[i.UnsupportedBrowser=-6]="UnsupportedBrowser",i[i.AuthenticationExpired=-7]="AuthenticationExpired",(i=n.LSServerError||(n.LSServerError={}))[i.WrongCredentials=1]="WrongCredentials",i[i.AllowedSessionCountReached=7]="AllowedSessionCountReached",i[i.SessionCountLimitReached=8]="SessionCountLimitReached",i[i.ServerTooBusy=9]="ServerTooBusy",i[i.ServerBlocked=10]="ServerBlocked",(i=n.ConnectMode||(n.ConnectMode={})).SOCIAL="Social",i.JWT="JWT",i.READ_ONLY="Read-only",i.N4R="N4R",i.NO_REGISTRATION="NoRe",i.EMAIL="Email",(i=n.SharedEvent||(n.SharedEvent={})).PageShowing="page_showing",i.PageHiding="page_hiding",i.ConnectionStatus="connection_status",i.Authentication="authentication",i.Load="load",i.LoadError="load_error",i.UserUpdated="user_updated"},{}],4:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.creditExhaustedError=void 0;var i=e(43),e=e(44);n.creditExhaustedError=new i.default(e.ApiErrorCode.CREDIT_EXHAUSTED,"The credits for this site have been exhausted or this site was disabled. Please check your Now4real dashboard at dashboard.now4real.com to upgrade your plan and/or re-enable Now4real")},{43:43,44:44}],5:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});e=e(40);n.default=new e.default},{40:40}],6:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var s=e(35),a=e(2),u=e(43),l=e(44),i=e(29),o=e(39),c=e(4);function r(e,t,n){void 0===n&&(n=!1),this.siteCtx=e,this.ourOrigin=t,this.gTranslateRemapped=n}r.prototype.parse=function(e){e=JSON.parse(e);return{status:e.s,master:e.m,group:e.g,logo:e.l,version:e.v,siteKey:e.k,auth:e.a,whiteLabel:e.w,conf:e.c}},r.prototype.check=function(){var r=this;return new Promise(function(i,o){r.fetch(r.siteCtx).then(function(e){var t=e.responseHeaders,e=e.responseText;s.default(a.DEBUG_LEVEL,"Obtained",t,e);try{var n=r.parse(e);0===n.status?o(c.creditExhaustedError):(r.current=n,i(n))}catch(e){o(new u.default(l.ApiErrorCode.TECHNICAL_PROBLEM,e.message))}}).catch(function(e){s.default(a.DEBUG_LEVEL,e.statusCode),403!==e.statusCode||r.gTranslateRemapped?o(e):(e=r.parse('{"s":1,"v":-1}'),r.current=e,i(e))})})},r.prototype.initialCheck=function(e){var t=this;return e?(e=this.parse(JSON.stringify(e)),this.current=e,Promise.resolve(e)):o.retry(function(){return t.check()},{errKey:"statusCode",errCodes:"*",retries:3,delay:5e3}).catch(function(e){throw e.statusCode?new u.default(l.ApiErrorCode.TECHNICAL_PROBLEM,e.statusCode.toString()):e})},r.prototype.fetch=function(e){return i.default.GET(this.ourOrigin+"/conf/"+encodeURIComponent(e)+"/json")},r.prototype.get=function(){return this.current},r.prototype.getRaw=function(){var e=this.current;return{s:e.status,m:e.master,g:e.group,l:e.logo,v:e.version,k:e.siteKey,a:e.auth,w:e.whiteLabel,c:e.conf}},r.prototype.update=function(e){try{return this.current=this.parse(e),this.current}catch(e){s.default(a.ERROR_LEVEL,"Conf update error",e)}},n.default=r},{2:2,29:29,35:35,39:39,4:4,43:43,44:44}],7:[function(e,t,n){function i(){}Object.defineProperty(n,"__esModule",{value:!0}),i.jwtProviderFnPresence=!1,i.loaderChannel=null,i.bandwidthReducer=null,n.default=i},{}],8:[function(e,t,n){var o=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var i=Array(e),o=0,t=0;t<n;t++)for(var r=arguments[t],s=0,a=r.length;s<a;s++,o++)i[o]=r[s];return i},r=(Object.defineProperty(n,"__esModule",{value:!0}),e(41));function i(e){if(this.subscribed=!1,this.subscribers=[],this.prefix=e.prefix,this.context=e.context,this.category=e.category,this.fields=e.subFields,this.mode=e.subMode,this.customContext=e.customContext,this.hidden=e.private||!1,this.special=e.special||!1,this.shareSubscription=e.shareSubscription||!1,void 0!==this.context){var t="";switch(this.context){case 0:t="p";break;case 1:t="s";break;case 2:t=2===this.category?"w|"+this.fields[0]:"w";break;case 3:t=this.customContext}this.id=this.prefix+"|"+t}else this.id=this.prefix;this.shareSubscription&&(this.id=this.id+="|"+this.fields.join(",")),this.initialSnapshot=e.initialSnapshot?r.cloneObject(e.initialSnapshot):null}i.prototype.toString=function(){return this.id},i.prototype.getSubscribers=function(){return this.subscribers},i.prototype.subscribedBy=function(e){-1===this.subscribers.indexOf(e)&&this.subscribers.push(e)},i.prototype.unsubscribedBy=function(e){e=this.subscribers.indexOf(e);-1<e&&this.subscribers.splice(e,1)},i.prototype.initSnapshot=function(e){this.snapshot=r.cloneObject(this.initialSnapshot),e[this.name]=this.snapshot,this.subscribed=!0},i.prototype.updateSnapshot=function(e,t){var n=this.snapshot;if(null==e)n=e;else if(r.isArray(e))r.isArray(n)?n.splice.apply(n,o([0,n.length],e)):n=e;else if(r.isObject(e))if(r.isObject(n)){for(var i in e)n[i]=e[i];for(var i in n)i in e||delete n[i]}else n=e;else n=e;this.snapshot=n,t[this.name]=n},i.prototype.deleteSnapshot=function(e){this.updateSnapshot(void 0,e),this.subscribed=!1},i.prototype.resetSnapshot=function(e){this.updateSnapshot(this.initialSnapshot,e)},i.prototype.setListener=function(e){this.listener=e},i.prototype.resetListener=function(){this.listener=void 0},i.prototype.isHidden=function(){return this.hidden},i.prototype.isSubscribed=function(){return this.subscribed},i.prototype.isSpecial=function(){return this.special},i.prototype.isCustom=function(){return void 0!==this.customContext},i.prototype.isDynamic=function(){return 3===this.context},n.default=i},{41:41}],9:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var o=e(8),i=e(2),r=e(44),s=e(35),a=e(2);function u(){var e;this.PRESENCE_SUB_FIELDS=["p"],this.PARAMETER_SUB_FIELDS=["ml","md","mlm","cd","mh","gr"],this.EVENTS_SUB_FIELDS=["t"],this.CHAT_SUB_FIELDS=[i.default.KEY,i.default.COMMAND,"u","i","p","r","s","d"],this.USER_LIST_SUB_FIELDS=[i.default.KEY,i.default.COMMAND,"n","i","p","r","b","bf","bb"],this.COUNTERS_SUBS_FIELDS=["c"],this.RANKING_SUB_FIELDS=[i.default.KEY,i.default.COMMAND,"i","t","c","p"],this.HEATMAP_SUB_FIELDS=["c","h"],this.TYPING_SUB_FIELDS=[i.default.KEY,i.default.COMMAND],this.POLL_SUB_FIELDS=["q","o","v","t","m","b"],this.POLL_STATUS_SUB_FIELDS=["q","m"],this.COUNTER_INITIAL_SNAPSHOT={value:null},this.RANKING_INITIAL_SNAPSHOT=[],this.HEATMAP_INITIAL_SNAPSHOT={},this.CHAT_INITIAL_SNAPSHOT=[],this.TYPING_INITIAL_SNAPSHOT=[],this.POLL_INITIAL_SNAPSHOT=null,this.CONNECTION_STATUS_INITIAL_SNAPSHOT={status:null},this.LOGIN_STATUS_INITIAL_SNAPSHOT={status:"NOT_AUTHENTICATED"},this.PARAMETERS_INITIAL_SNAPSHOT={messageMaxLength:null,messageMaxLengthModerator:null,messageMaxLengthGuest:null,messageDurationValue:null,messageDurationUnit:null,chatStatus:null,clickableLinks:null,gifsStatus:null},this.CONTEXTABLE_SUBJECTS=[r.SubscriptionSubject.COUNTER_PAGE_VIEWERS,r.SubscriptionSubject.COUNTER_PAGE_CHATTERS,r.SubscriptionSubject.COUNTER_CHAT_TYPING],this.subjects=((e={})[r.SubscriptionSubject.CONNECTION_STATUS]=new o.default({category:0,initialSnapshot:this.CONNECTION_STATUS_INITIAL_SNAPSHOT,prefix:"_cs",special:!0}),e[r.SubscriptionSubject.LOGIN_STATUS]=new o.default({category:0,initialSnapshot:this.LOGIN_STATUS_INITIAL_SNAPSHOT,prefix:"_ls",special:!0}),e[r.SubscriptionSubject.AUTHORIZATION]=new o.default({category:0,initialSnapshot:{},prefix:"_a",special:!0}),e[r.SubscriptionSubject.PARAMETERS]=new o.default({category:8,initialSnapshot:this.PARAMETERS_INITIAL_SNAPSHOT,prefix:"Par",special:!0,subFields:this.PARAMETER_SUB_FIELDS,subMode:"MERGE"}),e[i.default.EVENTS]=new o.default({category:9,prefix:"E",special:!1,subFields:this.EVENTS_SUB_FIELDS,subMode:"DISTINCT"}),e[i.default.PRESENCE_FOREGROUND]=new o.default({category:1,context:0,private:!0,prefix:"PF",subFields:this.PRESENCE_SUB_FIELDS,subMode:"RAW"}),e[i.default.PRESENCE_TYPING]=new o.default({category:1,context:0,private:!0,prefix:"PT",subFields:this.PRESENCE_SUB_FIELDS,subMode:"RAW"}),e[i.default.MESSAGE_USER_LIST]=new o.default({category:7,private:!0,prefix:"Mu",subFields:this.USER_LIST_SUB_FIELDS,subMode:"COMMAND"}),e[r.SubscriptionSubject.RANKING_PAGE_VIEWERS]=new o.default({category:4,context:0,initialSnapshot:this.RANKING_INITIAL_SNAPSHOT,prefix:"RF",subFields:this.RANKING_SUB_FIELDS,subMode:"COMMAND"}),e[r.SubscriptionSubject.RANKING_PAGE_CHATTERS]=new o.default({category:4,context:0,initialSnapshot:this.RANKING_INITIAL_SNAPSHOT,prefix:"RA",subFields:this.RANKING_SUB_FIELDS,subMode:"COMMAND"}),e.RANKING_SITE_VIEWERS=new o.default({category:4,context:2,private:!0,initialSnapshot:this.RANKING_INITIAL_SNAPSHOT,prefix:"RsF",subFields:this.RANKING_SUB_FIELDS,subMode:"COMMAND"}),e.RANKING_SITE_CHATTERS=new o.default({category:4,context:2,private:!0,initialSnapshot:this.RANKING_INITIAL_SNAPSHOT,prefix:"RsA",subFields:this.RANKING_SUB_FIELDS,subMode:"COMMAND"}),e[r.SubscriptionSubject.LIST_CHAT_TYPING]=new o.default({category:6,context:0,initialSnapshot:this.TYPING_INITIAL_SNAPSHOT,prefix:"LT",subFields:this.TYPING_SUB_FIELDS,subMode:"COMMAND"}),e[r.SubscriptionSubject.LIST_CHAT_MESSAGES]=new o.default({category:3,context:0,initialSnapshot:this.CHAT_INITIAL_SNAPSHOT,prefix:"M",subFields:this.CHAT_SUB_FIELDS,subMode:"COMMAND"}),e[r.SubscriptionSubject.COUNTER_PAGE_VIEWERS]=new o.default({category:2,context:0,initialSnapshot:this.COUNTER_INITIAL_SNAPSHOT,prefix:"CF",subFields:this.COUNTERS_SUBS_FIELDS,subMode:"MERGE"}),e[r.SubscriptionSubject.COUNTER_PAGE_CHATTERS]=new o.default({category:2,context:0,initialSnapshot:this.COUNTER_INITIAL_SNAPSHOT,prefix:"CA",subFields:this.COUNTERS_SUBS_FIELDS,subMode:"MERGE"}),e[r.SubscriptionSubject.COUNTER_SITE_VIEWERS]=new o.default({category:2,context:1,initialSnapshot:this.COUNTER_INITIAL_SNAPSHOT,prefix:"CF",subFields:this.COUNTERS_SUBS_FIELDS,subMode:"MERGE"}),e[r.SubscriptionSubject.COUNTER_SITE_CHATTERS]=new o.default({category:2,context:1,initialSnapshot:this.COUNTER_INITIAL_SNAPSHOT,prefix:"CA",subFields:this.COUNTERS_SUBS_FIELDS,subMode:"MERGE"}),e[r.SubscriptionSubject.COUNTER_CHAT_MESSAGES]=new o.default({category:2,context:0,initialSnapshot:this.COUNTER_INITIAL_SNAPSHOT,prefix:"CM",subFields:this.COUNTERS_SUBS_FIELDS,subMode:"MERGE"}),e[r.SubscriptionSubject.COUNTER_CHAT_TYPING]=new o.default({category:2,context:0,initialSnapshot:this.COUNTER_INITIAL_SNAPSHOT,prefix:"CT",subFields:this.COUNTERS_SUBS_FIELDS,subMode:"MERGE"}),e.COUNTER_DOMAINS_GLOBAL=new o.default({category:2,context:2,private:!0,initialSnapshot:this.COUNTER_INITIAL_SNAPSHOT,prefix:"Ga",subFields:["hc"],subMode:"MERGE"}),e.COUNTER_CHAT_MESSAGES_GLOBAL=new o.default({category:2,context:2,private:!0,initialSnapshot:this.COUNTER_INITIAL_SNAPSHOT,prefix:"Ga",subFields:["mc"],subMode:"MERGE"}),e.COUNTER_USERS_GLOBAL=new o.default({category:2,context:2,private:!0,initialSnapshot:this.COUNTER_INITIAL_SNAPSHOT,prefix:"Ga",subFields:["uc"],subMode:"MERGE"}),e.PEAK_SITE_VIEWERS=new o.default({category:2,context:1,private:!0,initialSnapshot:this.COUNTER_INITIAL_SNAPSHOT,prefix:"CpF",subFields:this.COUNTERS_SUBS_FIELDS,subMode:"MERGE"}),e.PEAK_SITE_CHATTERS=new o.default({category:2,context:1,private:!0,initialSnapshot:this.COUNTER_INITIAL_SNAPSHOT,prefix:"CpA",subFields:this.COUNTERS_SUBS_FIELDS,subMode:"MERGE"}),e[r.SubscriptionSubject.HEATMAP_PAGE_VIEWERS]=new o.default({category:5,context:0,initialSnapshot:this.HEATMAP_INITIAL_SNAPSHOT,prefix:"HF",subFields:this.HEATMAP_SUB_FIELDS,subMode:"MERGE"}),e[r.SubscriptionSubject.HEATMAP_SITE_VIEWERS]=new o.default({category:5,context:1,initialSnapshot:this.HEATMAP_INITIAL_SNAPSHOT,prefix:"HF",subFields:this.HEATMAP_SUB_FIELDS,subMode:"MERGE"}),e[r.SubscriptionSubject.POLL]=new o.default({category:11,initialSnapshot:this.POLL_INITIAL_SNAPSHOT,prefix:"Po",subFields:this.POLL_SUB_FIELDS,subMode:"MERGE",shareSubscription:!0}),e[r.SubscriptionSubject.POLL_STATUS]=new o.default({category:10,initialSnapshot:this.POLL_INITIAL_SNAPSHOT,prefix:"Po",subFields:this.POLL_STATUS_SUB_FIELDS,subMode:"MERGE",shareSubscription:!0}),e)}u.getInstance=function(){return u.instance=u.instance?u.instance:new u},u.prototype.destroy=function(e){e=e.id;s.default(a.DEBUG_LEVEL,"Destroying: "+e),delete this.subjects[e]},u.prototype.find=function(e){var t=e.split(":"),n=t[0],t=t[1],i=this.subjects[n];return i&&void 0===i.name&&(this.subjects[n].name=n),void 0!==t&&-1<this.CONTEXTABLE_SUBJECTS.indexOf(n)?(s.default(a.DEBUG_LEVEL,"Custom page context founded: "+t),n=i.prefix+"|"+t,this.subjects[n]||(s.default(a.DEBUG_LEVEL,"Generating: "+e),(t=new o.default({category:i.category,initialSnapshot:i.initialSnapshot,prefix:i.prefix,subFields:i.fields,subMode:i.mode,context:3,customContext:t})).name=e,this.subjects[n]=t)):i},u.prototype.findSpecials=function(){var t=this;return Object.keys(this.subjects).filter(function(e){return!0===t.subjects[e].special}).map(function(e){return t.find(e)})},u.prototype.findFromId=function(e){for(var t in this.subjects)if(this.subjects[t].toString()===e)return this.subjects[t]},u.prototype.exposedNameList=function(){var t=this;return Object.keys(this.subjects).filter(function(e){return!0!==t.subjects[e].isHidden()})},n.default=u},{2:2,35:35,44:44,8:8}],10:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.isBot=n.isProbablyWebView=n.isSafari=n.isEdge=n.isIe=n.isEventSupported=n.isStorageAvailable=n.isMessageAvailable=n.retrieveVisibilityProperties=n.test=void 0;var i=e(35),o=e(2);function r(){var e,t;return void 0!==document.hidden?(e="hidden",t="visibilitychange"):void 0!==document.mozHidden?(e="mozHidden",t="mozvisibilitychange"):void 0!==document.msHidden?(e="msHidden",t="msvisibilitychange"):void 0!==document.webkitHidden&&(e="webkitHidden",t="webkitvisibilitychange"),{hidden:e,visibilityChange:t}}function s(){return"postMessage"in window}function a(){return window.storageAvailable}function u(e,t){var n=(e="on"+e)in t;return n||(t=t.setAttribute?t:document.createElement("div")).setAttribute&&t.removeAttribute&&(t.setAttribute(e,""),n="function"==typeof t[e],void 0!==t[e]&&(t[e]=void 0),t.removeAttribute(e)),n}n.test=function(e){switch(e){case 1:return u("message",window)&&s();case 0:return u("storage",window)&&a();case 2:var t=r().hidden;return void 0!==document[t];default:return i.default(o.WARN_LEVEL,"Unsupported feature",e),!1}},n.retrieveVisibilityProperties=r,n.isMessageAvailable=s,n.isStorageAvailable=a,n.isEventSupported=u,n.isIe=function(){return-1!==(e=navigator.userAgent,t=-1,"Microsoft Internet Explorer"===navigator.appName?null!==new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})").exec(e)&&(t=parseFloat(RegExp.$1)):"Netscape"===navigator.appName&&null!==new RegExp("Trident/.*rv:([0-9]{1,}[.0-9]{0,})").exec(e)&&(t=parseFloat(RegExp.$1)),t);var e,t},n.isEdge=function(){return 0<=navigator.userAgent.indexOf("Edge")},n.isSafari=function(){return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)},n.isProbablyWebView=function(){return/Version\/.{1,300}Chrome\/\d+\.\d+\.\d+\.\d+|; wv\).{1,300}Chrome\/\d+\.\d+\.\d+\.\d+|(?:iPod|iPod touch|iPhone|iPad);.{0,30}CPU.{0,30}OS[ +]\d+_\d+(?:_\d+|).{0,30} AppleNews\/\d+\.\d+(?:\.\d+|)|(?:iPod|iPhone|iPad).{1,200}Version\/\d+\.\d+(?:\.\d+|)(?!.{0,200} Safari)|(?:iPod|iPod touch|iPhone|iPad)(?!.{0,200} Safari)/.test(navigator.userAgent)},n.isBot=function(){return i.default(o.DEBUG_LEVEL,"UA: "+navigator.userAgent),/bot|crawler|spider/i.test(navigator.userAgent)}},{2:2,35:35}],11:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.default=function(){window.location.origin||(window.location.origin=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")),String.prototype.startsWith||(String.prototype.startsWith=function(e){return this.substr(0,e.length)===e}),String.prototype.endsWith||(String.prototype.endsWith=function(e){return-1!==this.indexOf(e,this.length-e.length)}),String.prototype.capitalize||(String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)})}},{}],12:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e(1),s=e(43),o=e(7),a=e(2),r=e(41);function u(e){this.reqId=0,this.requestsMap={},this.reqPrefix=r.generateRandom(8),this.destination=e,this.origin=e!==u.LOADER_DESTINATION||void 0!==i.default.TECHNICAL_CONF.file_name?"*":o.default.parentOrigin,this.setupMessagesListener()}u.prototype.getRequestId=function(){return this.reqPrefix+this.reqId++},u.prototype.setupMessagesListener=function(){function e(e){var t,n,i,o;(e.origin||e.originalEvent.origin)!==r.origin||(t=(e=e.data).cmd)!==a.default.RESOLVE&&t!==a.default.REJECT||(n=e.id,i=e.payload,t===a.default.REJECT&&(o=e.code,e=e.message,o)&&e&&(i=new s.default(o,e)),null!=(o=r.requestsMap[n])&&o[t](i),delete r.requestsMap[n])}var r=this;window.addEventListener("message",e,!1),this.messagesListener=e},u.prototype.send=function(e){var n=this,i=this.getRequestId();return this.destination.postMessage({id:i,cmd:e.cmd,payload:e.payload},this.origin),new Promise(function(e,t){n.requestsMap[i]={resolve:e,reject:t}})},u.prototype.reset=function(){for(var e=this.reqId=0,t=Object.keys(this.requestsMap);e<t.length;e++){var n=t[e];this.requestsMap[n].reject(new s.default("ABORTED","broken channel")),delete this.requestsMap[n]}window.removeEventListener("message",this.messagesListener)},u.LOADER_DESTINATION=window.parent,u.SELF_DESTINATION=window,n.default=u},{1:1,2:2,41:41,43:43,7:7}],13:[function(e,t,n){function i(e,t){this.cmd=e,this.payload=t}var o,r,s=this&&this.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}))(e,t)},function(e,t){function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),a=(Object.defineProperty(n,"__esModule",{value:!0}),n.UpdateConfigEvent=n.GetUpdatedJWTEvent=n.ReloadEvent=n.VerifyEvent=n.LoaderEvent=void 0,s(u,r=n.LoaderEvent=i),u);function u(e){return r.call(this,"verify",e)||this}n.VerifyEvent=a;s(c,l=i);var l,a=c;function c(e,t,n){return l.call(this,"reload",{startOpen:e,updatedSiteConf:t,reloadScriptConf:n})||this}n.ReloadEvent=a;s(E,d=i);var d,a=E;function E(){return d.call(this,"getUpdatedJWT",null)||this}n.GetUpdatedJWTEvent=a;s(f,h=i);var h,a=f;function f(e){return h.call(this,"updateConfig",{c:e})||this}n.UpdateConfigEvent=a},{}],14:[function(e,t,n){function i(e,t){this.cmd=e,this.payload=t}var o,r,s=this&&this.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}))(e,t)},function(e,t){function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),a=(Object.defineProperty(n,"__esModule",{value:!0}),n.SuggestionsUpdateEvent=n.SiteStatusUpdateEvent=n.LoggerEditEvent=n.ResponseEvent=n.SubjectUpdateEvent=n.LoadErrorEvent=n.LoadEvent=n.ProxyEvent=void 0,s(u,r=n.ProxyEvent=i),u);function u(e){return r.call(this,"load",e)||this}n.LoadEvent=a;s(c,l=i);var l,a=c;function c(e){return l.call(this,"error",e)||this}n.LoadErrorEvent=a;s(E,d=i);var d,a=E;function E(e){return d.call(this,"subjectUpdate",e)||this}n.SubjectUpdateEvent=a;s(f,h=i);var h,a=f;function f(e){return h.call(this,"response",e)||this}n.ResponseEvent=a;s(S,p=i);var p,a=S;function S(e){return p.call(this,"loggerEdit",e)||this}n.LoggerEditEvent=a;s(L,g=i);var g,a=L;function L(e){return g.call(this,"siteStatusUpdate",e)||this}n.SiteStatusUpdateEvent=a;s(_,C=i);var C,a=_;function _(e){return C.call(this,"suggestionsUpdate",e)||this}n.SuggestionsUpdateEvent=a},{}],15:[function(e,t,n){function i(e,t){this.type=e,this.data=t,this.timestamp=Date.now()}var o,r,s=this&&this.__extends||(o=function(e,t){return(o=Object.setPrototypeOf||({__proto__:[]}instanceof Array?function(e,t){e.__proto__=t}:function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])}))(e,t)},function(e,t){function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),a=(Object.defineProperty(n,"__esModule",{value:!0}),n.HeatmapEvent=n.RankingEvent=n.CounterEvent=n.PollStatusEvent=n.PollEvent=n.TypingUsersEvent=n.ParametersEvent=n.ChatEvent=n.AuthorizationEvent=n.LoginStatusEvent=n.ConnectionStatusEvent=n.Now4realSubjectUpdate=void 0,e(44)),e=(n.Now4realSubjectUpdate=i,s(u,r=i),u);function u(e){return r.call(this,a.SubscriptionSubject.CONNECTION_STATUS,e)||this}n.ConnectionStatusEvent=e;s(c,l=i);var l,e=c;function c(e){return l.call(this,a.SubscriptionSubject.LOGIN_STATUS,e)||this}n.LoginStatusEvent=e;s(E,d=i);var d,e=E;function E(e){return d.call(this,a.SubscriptionSubject.AUTHORIZATION,e)||this}n.AuthorizationEvent=e;s(f,h=i);var h,e=f;function f(e){return h.call(this,a.SubscriptionSubject.LIST_CHAT_MESSAGES,e)||this}n.ChatEvent=e;s(S,p=i);var p,e=S;function S(e){return p.call(this,a.SubscriptionSubject.PARAMETERS,e)||this}n.ParametersEvent=e;s(L,g=i);var g,e=L;function L(e){return g.call(this,a.SubscriptionSubject.LIST_CHAT_TYPING,e)||this}n.TypingUsersEvent=e;s(_,C=i);var C,e=_;function _(e){return C.call(this,a.SubscriptionSubject.POLL,e)||this}n.PollEvent=e;s(A,T=i);var T,e=A;function A(e){return T.call(this,a.SubscriptionSubject.POLL_STATUS,e)||this}n.PollStatusEvent=e;s(v,b=i);var b,e=v;function v(e,t){return b.call(this,e,t)||this}n.CounterEvent=e;s(N,m=i);var m,e=N;function N(e,t){return m.call(this,e,t)||this}n.RankingEvent=e;s(O,I=i);var I,e=O;function O(e,t){return I.call(this,e,t)||this}n.HeatmapEvent=e},{44:44}],16:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),new(e(17).Now4real)},{17:17}],17:[function(Z,e,$){!function(Q){!function(){var d=this&&this.__assign||function(){return(d=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},E=(Object.defineProperty($,"__esModule",{value:!0}),$.Now4real=void 0,Z(1)),h=Z(2),c=Z(7),f=Z(3),p=Z(41),e=Z(34),t=Z(42),S=Z(21),l=Z(26),G=Z(27),V=Z(28),j=Z(25),x=Z(37),F=Z(36),B=Z(32),H=Z(9),g=Z(18),k=Z(11),L=Z(15),a=Z(14),o=Z(13),W=Z(23),i=Z(10),u=Z(5),J=Z(30),Y=Z(31),C=Z(6),n=Z(19),K=Z(20),q=Z(24),r=Z(12),z=Z(39),_=Z(43),T=Z(45),A=Z(44),b=Z(35),v=Z(3),m=Z(2),s=0,N=1,I=2,O=3,R=4,y=5,X=(U.prototype.log=function(e,t){e>=this.level&&(e={timestamp:(new Date).toISOString(),category:this.category,level:e,message:t},(t=JSON.parse(localStorage.getItem("lightstreamer_logs"))||[]).push(e),localStorage.setItem("lightstreamer_logs",JSON.stringify(t)))},U.prototype.trace=function(e){this.log(s,e)},U.prototype.debug=function(e){this.log(N,e)},U.prototype.info=function(e){this.log(I,e)},U.prototype.warn=function(e){this.log(O,e)},U.prototype.error=function(e){this.log(R,e)},U.prototype.fatal=function(e){this.log(y,e)},U.prototype.isTraceEnabled=function(){return this.level<=s},U.prototype.isDebugEnabled=function(){return this.level<=N},U.prototype.isInfoEnabled=function(){return this.level<=I},U.prototype.isWarnEnabled=function(){return this.level<=O},U.prototype.isErrorEnabled=function(){return this.level<=R},U.prototype.isFatalEnabled=function(){return this.level<=y},U);function U(e,t){this.category=e,this.level=t}P.prototype.getLogger=function(e){return new X(e,this.level)};var D=P;function P(e){void 0===e&&(e=O),this.level=e}var w="undefined"!=typeof window?window.LS:void 0!==Q?Q.LS:null,D=(w.LightstreamerClient.setLoggerProvider(new D(N)),M.prototype.start=function(){b.default(m.INFO_LEVEL,w.LightstreamerClient.LIB_VERSION);try{this.initializeListeners();for(var e=this.subjects.findSpecials(),t=0,n=e;t<n.length;t++)n[t].initSnapshot(this);this.visibilityHandler.isPageVisible()&&this.load()}catch(e){throw new _.default(A.ApiErrorCode.TECHNICAL_PROBLEM,e.message)}},M.prototype.updateIntegratorStatus=function(e){b.default(m.DEBUG_LEVEL,"updateIntegratorStatus",e);var t=e.status,n=e.logo,e=e.whiteLabel;this.siteStatus=t,this._siteStatus=t,this._customLogo=void 0!==n?!!n:3===t,this._whiteLabel=void 0!==e&&e},M.prototype.notifyLoadError=function(e){var t=E.default.CONF.target;"api"!==t&&"api+widget"!==t&&"demo"!==t||this.notify(new a.LoadErrorEvent(e),"p"),"widget"!==t&&"api+widget"!==t&&"demo"!==t||p.isFunction(this.onerror)&&this.onerror.call(this,e),this.notifyDestroy(),u.default.publish(f.SharedEvent.LoadError,e)},M.prototype.notifyDestroy=function(){this.notify(new a.ProxyEvent("destroy",{}),"p")},M.prototype.notifyLoad=function(){var e,t=E.default.CONF.target;"api"!==t&&"api+widget"!==t&&"demo"!==t||((e=JSON.parse(E.default.CONF_SERIALIZED)).technicalConfig=E.default.TECHNICAL_CONF,e={cc:JSON.stringify(e),as:this.subjects.exposedNameList(),ll:E.default.LOGGER_LEVEL,ago:E.default.API_GATEWAY_ORIGIN,co:E.default.CDN_ORIGIN,uau:E.default.USER_APP_URL,ss:this.siteStatus,lv:this.version,pc:this.context.pageCtx,sc:this.context.siteCtx,gc:this.context.groupSiteCtx,wv:this.webViewMode,nrm:this.noRegistrationMode,em:this.emailMode,sk:null==(e=this.siteJSONConf.get())?void 0:e.siteKey,wll:this._whiteLabel,pars_snap:this.subjects.find(A.SubscriptionSubject.PARAMETERS).snapshot},this.notify(new a.LoadEvent(e),"p")),"widget"!==t&&"api+widget"!==t&&"demo"!==t||(this._fromFile=void 0!==E.default.TECHNICAL_CONF.file_name,this._standardAuthDisabled=this.webViewMode,this.analyticsMode)||this.onload.call(this),u.default.publish(f.SharedEvent.Load,null)},M.prototype.setLoadHandlers=function(e){e=window[e];this.onload=e&&p.isFunction(e.onload)?e.onload:function(){b.default(m.ERROR_LEVEL,"onload not setted")},this.onerror=e?e.onerror:null},M.prototype.checkDomain=function(){if("file:"===location.protocol)return!0;for(var e=E.default.ENABLED_DOMAINS,t=p.parseUrl(window.location.href).host,n=0,i=e;n<i.length;n++){var o=i[n];if(t.endsWith(o))return!0}return b.default(m.ERROR_LEVEL,"the domain is not enabled",t,e,window.location.href),!1},M.prototype.initializeAuthorization=function(e){var t=this;n.default.init(e),this.handleAuthorization(),n.default.onUpdate(function(e){t.lsConnectionManager.setPerms(n.default.getActivePerms()),t.handleAuthorization()}),this.lsConnectionManager.setPerms(n.default.getActivePerms())},M.prototype.handleSiteConf=function(e){var n,i,t,o=this,r=E.default.CONF,s=e.status,a=e.master,u=e.group,l=e.auth,a=((a||u)&&(this.context=this.contextManager.update(a,u)),r.context_check),u=this.context.siteCtx;a&&u!==E.default.SANDBOX_SITE_CONTEXT&&a!==u?this.notifyLoadError(new _.default(A.ApiErrorCode.INVALID_CALL,"the expected context_check had to be equal to: "+u+", got: "+a)):(this.updateIntegratorStatus(e),this.siteContext=this.context.siteCtx,this.pageContext=this.context.pageCtx,this.groupContext=this.context.groupSiteCtx,this.noRegistrationMode=2===l,this.emailMode=3===l,this.analyticsMode||(n=function(e){e.then(function(e){return o.lsMessageChannel.invokeGetAuthInfo().then(function(e){return g.default.storeDetails(e)})}).then(function(e){o.handleLogin(e)}).catch(function(e){g.default.storeUserId(null),o.handleSwitchError(e)})},i=function(e,t){e.then(function(e){g.default.resetDetails()}).then(function(e){return o.lsMessageChannel.invokeGetAuthInfo().then(function(e){return g.default.storeDetails(e)})}).then(function(e){o.handleLogout(!1)}).catch(function(e){g.default.storeUserId(t),o.handleSwitchError(e)})},this.noRegistrationMode?(t=c.default.storagePerSite.watch(E.default.NO_RE_AUTH_KEY,function(e){g.default.state.change(2),e?(g.default.storeUserId(e.id),n(o.lsConnectionManager.switchToAuthenticated(f.ConnectMode.NO_REGISTRATION,e.token))):(g.default.storeUserId(null),i(o.lsConnectionManager.switchToUnauthenticated(),g.default.getUserId()))}))&&this.cleanPile.push(t):this.emailMode?(t=c.default.storagePerSite.watch(E.default.EMAIL_AUTH_KEY,function(e){g.default.state.change(2),e?(g.default.storeUserId(e.id),n(o.lsConnectionManager.switchToAuthenticated(f.ConnectMode.EMAIL,e))):(g.default.storeUserId(null),i(o.lsConnectionManager.switchToUnauthenticated(),g.default.getUserId()))}))&&this.cleanPile.push(t):this.JWTMode||(u=S.default.watch(h.default.STORAGE_LOGIN_KEY,function(e,t){e?(null==t?void 0:t.id)===e.id?(b.default(m.DEBUG_LEVEL,"onCredentialUpdated call"),o.handleLogin(e)):(b.default(m.DEBUG_LEVEL,"onCredentialStored call"),g.default.state.change(2),g.default.storeUserId(e.id),n(o.lsConnectionManager.switchToAuthenticated(f.ConnectMode.SOCIAL,e))):(b.default(m.DEBUG_LEVEL,"onCredentialDeleted call"),g.default.state.change(2),g.default.storeUserId(null),i(o.lsConnectionManager.switchToUnauthenticated(),g.default.getUserId()))}))&&this.cleanPile.push(u)),E.default.TECHNICAL_CONF.our_origin=this.context.ourOrigin,E.default.LOCAL_PERSISTENCE=r.local_persistence||!(null!=(a=null==r?void 0:r.custom_auth)&&a.enabled)||3!==s,this.browserPreferences=new K.default(this.context.groupSiteCtx||this.context.siteCtx),this.lsConnectionManager.enableFelsCacher(),1!==s||this.analyticsMode||b.default(m.WARN_LEVEL,"Verify "+this.siteContext+" for free in the Now4real Dashboard to get analytics, notifications, and more. Go to https://dashboard.now4real.com and follow the instructions."),this.currentConf=e)},M.prototype.handleAuthInfo=function(e,t){b.default(m.DEBUG_LEVEL,"Auth info",e,t),g.default.storeDetails(e),this.initializeAuthorization(e)},M.prototype.load=function(){var n=this;b.default(m.DEBUG_LEVEL,"Loading NOW4REAL",this.version),this.isLoaded=!0,this.webViewMode=i.isProbablyWebView(),this.initializeLsConnectionManager(),this.initLsMessageChannel(this.lsClient),this.userPreferences=new q.default(this.lsMessageChannel,function(){return n.subjects},function(e){n.handleLogin(e)}),this.initBandwidthReducer(),this.initChatSnapshotClearer();this.makeParametersSub(),c.default.loaderChannel=new r.default(r.default.LOADER_DESTINATION),this.cleanPile.push(function(e){c.default.loaderChannel.reset()}),this.JWTMode&&c.default.jwtProviderFnPresence&&this.makeEventsSub(),!this.analyticsMode&&this.visibilityHandler.isPageVisible()&&this.makePresenceSub(),this.attachEnums(),this.lsConnectionManager.firstConnection().then(function(e){return Promise.all([n.lsMessageChannel.invokeGetAuthInfo(),e])}).then(function(e){var t=e[0],e=e[1];n.handleSiteConf(n.siteJSONConf.get()),n.handleAuthInfo(t,e),n.handleLoginStatus(e)}).then(function(e){n.notifyLoad()}).catch(function(e){e.code===A.ApiErrorCode.RELOAD_REQUIRED?n.reload({updatedSiteConf:JSON.parse(e.message),reloadScriptConf:!1}):n.notifyLoadError(e)})},M.prototype.attachEnums=function(){this.Subject=A.SubscriptionSubject,this.ErrorCode=A.ApiErrorCode},M.prototype.handleLoginStatus=function(e){var t;0===g.default.state.actual&&(t=g.default.getUser(),e!==f.ConnectMode.READ_ONLY&&e!==f.ConnectMode.N4R&&(e!==f.ConnectMode.JWT&&e!==f.ConnectMode.NO_REGISTRATION&&e!==f.ConnectMode.EMAIL||t)?this.handleLogin(t):this.handleLogout(!1))},M.prototype.readConfiguration=function(){window.n4rConfig||window.n4rTechnicalConfig?(e=window.n4rConfig,t=window.n4rTechnicalConfig,n=window.n4rConfig,o=i=null,this.analyticsMode=!window.n4rNoAnalytics):(s=p.extractFragment(),e=(r=T.deserializeConf(s)).config,t=r.technicalConfig,n=r.scriptConfig,i=r.updatedConfig,o=s),E.default.CONF=e,E.default.CONF_SERIALIZED=o,E.default.TECHNICAL_CONF=t,E.default.SCRIPT_CONF=n;var e,t,n,i,o,r=e.logger,s=(r&&(E.default.LOGGER_LEVEL=v.LoggerLevels[r.capitalize()]),E.default.API_GATEWAY_ORIGIN=p.computeApiGatewayOrigin(E.default.TECHNICAL_CONF.env_subdom),E.default.CDN_ORIGIN=p.computeCdnOrigin(E.default.TECHNICAL_CONF.env_subdom),E.default.USER_APP_URL=p.computeUserAppURL(E.default.TECHNICAL_CONF.env_subdom),e.custom_auth);return this.JWTMode=null==s?void 0:s.enabled,c.default.jwtProviderFnPresence="fn"===(null==s?void 0:s.jwt),b.default(m.DEBUG_LEVEL,"Extracted configuration",E.default.CONF,E.default.TECHNICAL_CONF,E.default.SCRIPT_CONF),i},M.prototype.updateConfiguration=function(e){var e=decodeURIComponent(e.substring(1)),t=T.deserializeConf(e),n=t.config,i=t.technicalConfig,t=t.scriptConfig,e=(E.default.CONF=n,E.default.CONF_SERIALIZED=e,E.default.TECHNICAL_CONF=i,E.default.SCRIPT_CONF=t,n.logger);e&&(E.default.LOGGER_LEVEL=v.LoggerLevels[e.capitalize()]),b.default(m.DEBUG_LEVEL,"Updated configuration",E.default.CONF,E.default.TECHNICAL_CONF,E.default.SCRIPT_CONF)},M.prototype.handleGlobal=function(){var e=this.analyticsMode&&E.default.TECHNICAL_CONF.global_name?E.default.TECHNICAL_CONF.global_name:"now4real";this.setLoadHandlers(e),window[e]=this},Object.defineProperty(M.prototype,"config",{get:function(){return E.default.CONF},enumerable:!1,configurable:!0}),M.prototype.initializeListeners=function(){var d=this;this.visibilityHandler=new t.default({onPageHiding:function(){b.default(m.DEBUG_LEVEL,"onPageHiding call",document.visibilityState),localStorage.setItem("onPageHiding",""+new Date),u.default.publish(f.SharedEvent.PageHiding,null)},onPageShowing:function(){b.default(m.DEBUG_LEVEL,"onPageShowing call"),d.isLoaded?u.default.publish(f.SharedEvent.PageShowing,null):d.load()},onPageTerminated:function(){b.default(m.DEBUG_LEVEL,"onPageTerminated call"),d.lsClient.disconnect()}}),this.cleanPile.push(function(){d.visibilityHandler.reset()}),e.default.init({onProxyCommand:function(t,n,e){b.default(m.DEBUG_LEVEL,"onProxyCommand call",t,n,e);function i(e){e.then(function(e){d.respondToProxy(t,n,o,e)}).catch(function(e){d.respondToProxy(t,n,r,e)})}var o="resolve",r="reject",s="subject";switch(n){case"startProxyLogin":i(d.startProxyLogin());break;case"stopProxyLogin":d.stopProxyLogin();break;case"reload":d.reload(e[0]);break;case"subscribe":var a=e[0];d.subscribe(a,null,e[1],!0).then(function(e){e[s]=a,d.respondToProxy(t,n,o,e)}).catch(function(e){e[s]=a,d.respondToProxy(t,n,r,e)});break;case"unsubscribe":var u=e[0];d.unsubscribe(u,!0).then(function(e){e[s]=u,d.respondToProxy(t,n,o,e)}).catch(function(e){e[s]=u,d.respondToProxy(t,n,r,e)});break;case"post":i(d.post(e[0],e[1],!0));break;case"logout":case"deleteMessage":case"flushChat":case"setChatEnabled":case"getMute":case"setMute":case"startTyping":case"stopTyping":case"reportMessage":case"registerUserConsent":case"createPoll":case"closePoll":case"sendVote":case"getPollVote":case"setLoggerLevel":i(d[n].apply(d,e));break;case"browserPreferences.getItem":case"browserPreferences.setItem":case"browserPreferences.removeItem":var l=n.split("."),c=d[l[0]];i(c[l[1]].apply(c,e));break;default:b.default(m.WARN_LEVEL,"Unsupported message",t,n,e)}}},this.context.parentOrigin,this.context.ourOrigin),this.cleanPile.push(function(){e.default.reset()})},M.prototype.handleSwitchError=function(e){var t;-1<e.message.indexOf("client")?t="DISCONNECTED:UNSUPPORTED_CLIENT":-1<e.message.indexOf("browser")?t="DISCONNECTED:UNSUPPORTED_BROWSER":e.code===A.ApiErrorCode.CREDIT_EXHAUSTED&&(t="DISCONNECTED:CREDIT_EXHAUSTED"),t&&(this.handleConnectionStatus(t),this.handleClearSnapshot())},M.prototype.initializeLsConnectionManager=function(){var t=this,e=F.default.getInstance(),n=e.init(this.version,this.siteJSONConf,this.context.siteCtx,"demo"===E.default.CONF.target,this.analyticsMode,this.JWTMode,this.webViewMode);e.addStatusListener({onStatusChanged:function(e){t.handleConnectionStatus(e),u.default.publish(f.SharedEvent.ConnectionStatus,e)},onJWTExpired:function(){t.handleConnectionStatus("DISCONNECTED:JWT_EXPIRED"),t.handleClearSnapshot(),t.handleUnrecoverableStatus(!1)},onConfigChanged:function(){t.handleConnectionStatus("DISCONNECTED:CONFIG_CHANGED"),t.handleClearSnapshot(),t.handleUnrecoverableStatus(!1)},onCreditExhausted:function(){t.handleConnectionStatus("DISCONNECTED:CREDIT_EXHAUSTED"),t.handleClearSnapshot(),t.handleUnrecoverableStatus(!1)},onUnsupportedClient:function(){t.handleConnectionStatus("DISCONNECTED:UNSUPPORTED_CLIENT"),t.handleClearSnapshot(),t.handleUnrecoverableStatus(!1)},onCredentialExpired:function(){g.default.state.change(2),g.default.storeUserId(null),e.switchToUnauthenticated().then(function(e){g.default.resetDetails()}).then(function(e){return t.lsMessageChannel.invokeGetAuthInfo().then(function(e){return g.default.storeDetails(e)})}).then(function(e){t.handleLogout()})},onConfigChange:function(e){t.updateConfiguration(e)}}),this.lsConnectionManager=e,this.lsClient=n,this.lsConnectionDetails=n.connectionDetails},M.prototype.initLsMessageChannel=function(e){var t=this,n=x.default.getInstance();n.init(e,function(){return t.contextManager.context}),this.lsMessageChannel=n,g.default.lsMessageChannel=n},M.prototype.initBandwidthReducer=function(){var e=this,t=new J.default(u.default,this.visibilityHandler);t.init(function(){e.lsConnectionManager.disconnectClient()},function(){0!==e.siteStatus&&e.lsConnectionManager.reconnectClient()}),c.default.bandwidthReducer=t},M.prototype.initChatSnapshotClearer=function(){var e=this;this.chatSnapshotClearer=new Y.default(u.default,function(){e.notifyClearSnapshot(e.subjects.find(A.SubscriptionSubject.LIST_CHAT_MESSAGES)),b.default(m.DEBUG_LEVEL,"chat snapshot cleared")})},M.prototype.makePresenceSub=function(){this.subscriptionFactory(this.subjects.find(h.default.PRESENCE_FOREGROUND)),u.default.subscribe(f.SharedEvent.PageHiding,this.unsubscribePageForegroundPresenceItem.bind(this)),u.default.subscribe(f.SharedEvent.PageShowing,this.subscribePageForegroundPresenceItem.bind(this))},M.prototype.notifySubjectEvent=function(e,t){var n=this;p.enqueueMicrotask(function(){n.notifyEvent(e,t||null)})},M.prototype.notifyEvent=function(e,t){var n,i=this.subjects.find(e.type),t=t||i.getSubscribers();if(b.default(m.DEBUG_LEVEL,"notifyEvent for subject: "+this.subjects.find(e.type).name,e,t),-1<t.indexOf(1)&&(n=new a.SubjectUpdateEvent({lsn:e.type,data:e}),this.notify(n,"p")),-1<t.indexOf(0)&&p.isFunction(i.listener)){e.data&&delete e.data._snap;try{i.listener(e)}catch(e){b.default(m.ERROR_LEVEL,e.message)}}},M.prototype.notify=function(e,t){var n,i;!this.context||this.analyticsMode&&"p"===t||(i=n=void 0,i="p"===t?(n=window.parent,void 0!==E.default.TECHNICAL_CONF.file_name?"*":this.context.parentOrigin):(n=window,"*"),n.postMessage({cmd:e.cmd,payload:p.cloneObject(e.payload)},i))},M.prototype.notifyLogin=function(e){e=new L.LoginStatusEvent(e);this.notifySubjectEvent(e,[0,1])},M.prototype.notifyLogout=function(e){e=new L.LoginStatusEvent(e);this.notifySubjectEvent(e,[0,1])},M.prototype.handleConnectionStatus=function(e){var t=this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS),n=t.snapshot.status;e!==n&&("DISCONNECTED"!==e||"DISCONNECTED:CREDIT_EXHAUSTED"!==n&&"DISCONNECTED:CONFIG_CHANGED"!==n&&"DISCONNECTED:UNSUPPORTED_CLIENT"!==n&&"DISCONNECTED:JWT_EXPIRED"!==n)&&(t.updateSnapshot(n={status:e},this),this.notifySubjectEvent(new L.ConnectionStatusEvent(n),[0,1]))},M.prototype.handleAuthorization=function(){this.subjects.find(A.SubscriptionSubject.AUTHORIZATION).updateSnapshot(n.default.state,this),this.notifyEvent(new L.AuthorizationEvent(n.default.state),[0,1])},M.prototype.getUserInfo=function(n){var e=this,t=this.userInfoCache.get(n);return void 0===t?(b.default(m.DEBUG_LEVEL,n+" not found in cache"),new Promise(function(t){e.userInfoCache.watch(n,function(e){b.default(m.DEBUG_LEVEL,"Resolved "+n,e),t(e)})})):Promise.resolve(t)},M.prototype.subscriptionFactory=function(i,e,t,o){var r,s,a,u=this,l=i.toString(),n=i.category,c=!1,d=new Promise(function(t,n){s=function(){var e="onSubscription call: "+l;c&&(e="re-".concat(e)),b.default(m.DEBUG_LEVEL,e),c?u.handleClearSnapshot(i):(t({}),o&&p.isFunction(o.onAfterFirstSub)&&o.onAfterFirstSub(),c=!0)},a=function(e,t){c?b.default(m.ERROR_LEVEL,"Automatic "+l+" subscription recovery error",e,t):(delete u.subs[l],e===f.N4RServerError.Unauthorized?n(new _.default(A.ApiErrorCode.NOT_AUTHORIZED,'not authorized to perform the "'+i.id+'" subscription')):n(new _.default(A.ApiErrorCode.TECHNICAL_PROBLEM,e.toString())))}}),E={_onSubscription:s,_onSubscriptionError:a,_onItemLostUpdates:function(e,t,n){b.default(m.WARN_LEVEL,l+" itemLostUpdates call",e,t,n),u.handleClearSnapshot(i),u.lsClient.unsubscribe(r),u.lsClient.subscribe(r)},_onClearSnapshot:function(e,t){b.default(m.DEBUG_LEVEL,l+" onClearSnapshot call",e,t),u.handleClearSnapshot(i)}};if(t)for(var h in t)E[h]=t[h];switch(n){case 3:r=this.makeChatSubscription(i,E,e);break;case 6:r=this.makeTypingSubscription(i,E);break;case 1:r=this.makePresenceSubscription(i,E);break;case 9:r=this.makeEventsSubscription(i,E);break;case 2:r=this.makeCounterSubscription(i,E);break;case 4:r=this.makeRankingSubscription(i,E);break;case 5:r=this.makeHeatmapSubscription(i,E);break;case 8:r=this.makeParametersSubscription(i,E);break;case 7:r=this.makeMessageUserListSubscription(i,E);break;case 11:r=this.makePollSubscription(i,E);break;case 10:r=this.makePollStatusSubscription(i,E)}return this.lsClient.subscribe(r),this.subs[l]=r,d},M.prototype.makePollSubscription=function(u,e){var l=this,t=u.prefix+":"+(E.default.CONF.scope===h.default.SITE?this.context.groupHomePage||this.context.homePage:this.context.visualizedPage),t=(b.default(m.DEBUG_LEVEL,"Computed item: "+t),new w.Subscription(u.mode,t,u.fields));return t.setRequestedSnapshot("yes"),t.addListener({onSubscription:e._onSubscription,onSubscriptionError:e._onSubscriptionError,onItemUpdate:function(e){var n,e=p.remap(e.getValue,e),t=e("b"),i=e("q"),o=e("o"),r=e("v"),s=e("t"),e=e("m"),a=(b.default(m.DEBUG_LEVEL,u.id+" update ("+l.lsConnectionDetails.getSessionId()+")",t,i,o,r,s,e),null),r=(i&&(o=o.split("\t"),n=p.decodePercentage(r),a={closed:null===e,question:i,answers:o.map(function(e,t){return{text:e,percentage:n[t]}}),votesCount:s,multipleChoice:1<Number(e),startDate:p.parseTimestamp(t)}),u.updateSnapshot(a,l),new L.PollEvent(a));l.notifySubjectEvent(r)}}),t},M.prototype.makePollStatusSubscription=function(i,e){var o=this,t=i.prefix+":"+(E.default.CONF.scope===h.default.SITE?this.context.groupHomePage||this.context.homePage:this.context.visualizedPage),t=(b.default(m.DEBUG_LEVEL,"Computed item: "+t),new w.Subscription(i.mode,t,i.fields));return t.setRequestedSnapshot("yes"),t.addListener({onSubscription:e._onSubscription,onSubscriptionError:e._onSubscriptionError,onItemUpdate:function(e){var e=p.remap(e.getValue,e),t=e("q"),e=e("m"),n=(b.default(m.DEBUG_LEVEL,i.id+" update ("+o.lsConnectionDetails.getSessionId()+")",t,e),null),t=(i.updateSnapshot(n=t?{question:t,closed:null===e}:n,o),new L.PollStatusEvent(n));o.notifySubjectEvent(t)}}),t},M.prototype.makeEventsSubscription=function(t,e){var n=this,i=t.prefix+":"+h.default.GLOBAL_SUB_SUFFIX,i=(b.default(m.DEBUG_LEVEL,"Computed item: "+i),new w.Subscription(t.mode,i,t.fields));return i.addListener({onSubscription:e._onSubscription,onSubscriptionError:e._onSubscriptionError,onItemUpdate:function(e){e=p.remap(e.getValue,e)("t");b.default(m.DEBUG_LEVEL,t.prefix+" update ("+n.lsConnectionDetails.getSessionId()+")",e),"e"===e&&z.timeout(E.default.JWT_RESOLVER_TIMEOUT,c.default.loaderChannel.send(new o.GetUpdatedJWTEvent)).then(function(e){b.default(m.DEBUG_LEVEL,"obtained new JWT",e);try{n.lsConnectionManager.updateJWT(e),n.lsMessageChannel.invokeJWTRefresh(e)}catch(e){throw e}}).catch(function(e){b.default(m.ERROR_LEVEL,e.message)})}}),i.setRequestedSnapshot("no"),i.setDataAdapter("EVENT"),i},M.prototype.makeMessageUserListSubscription=function(l,e){var c=this,t=l.prefix+":"+(E.default.CONF.scope===h.default.SITE?this.context.groupHomePage||this.context.homePage:this.context.visualizedPage),t=(b.default(m.DEBUG_LEVEL,"Computed item: "+t),new w.Subscription(l.mode,t,l.fields));return t.setRequestedSnapshot(h.default.YES),t.addListener({onSubscription:e._onSubscription,onSubscriptionError:e._onSubscriptionError,onItemUpdate:function(e){var t,n,i,o,r,s,a,u=p.remap(e.getValue,e),e=(b.default(m.DEBUG_LEVEL,l.prefix+" update ("+c.lsConnectionDetails.getSessionId()+", "+e.isSnapshot()+")",u(h.default.COMMAND)+"-"+u(h.default.KEY)+"-"+u("n")+"-"+u("i")+"-"+u("p")+"-"+u("r")+"-"+u("b")+"-"+u("bf")+"-"+u("bb")),u(h.default.COMMAND));e!==h.default.ADD&&e!==h.default.UPDATE||(e=u(h.default.KEY),t=u("n"),n=u("i"),i=u("p"),o=u("r"),s=u("b"),a=u("bf"),u=u("bb"),r=null,o&&(r=p.authDetailsParser(o,s,a,u)),a=p.createUser(s={id:e,nick:t,icon:n,provider:i},r?r.role:null,r?r.badge:null),c.userInfoCache.set(a),(u=c.subjects.find(A.SubscriptionSubject.LOGIN_STATUS).snapshot.user)&&u.id===a.id&&(c.noRegistrationMode||c.emailMode||S.default.updateUser(t,n),g.default.updateRole(o?r.role:null,o?r.badge:null),c.handleLogin(s)))}}),t},M.prototype.makePresenceSubscription=function(e,t){var n=E.default.CONF.scope===h.default.SITE&&e.name===h.default.PRESENCE_TYPING?h.default.GROUP_PLACEHOLDER+"/":""+h.default.MASTER_PLACEHOLDER+this.context.pageCtx,n=e.prefix+":"+n,n=(b.default(m.DEBUG_LEVEL,"Computed item: "+n),new w.Subscription(e.mode,n,e.fields));return n.addListener({onSubscription:t._onSubscription,onSubscriptionError:t._onSubscriptionError}),n},M.prototype.makeChatSubscription=function(n,e,t){var i=this,o=n.toString(),r=n.prefix+":"+(E.default.CONF.scope===h.default.SITE?this.context.groupHomePage||this.context.homePage:this.context.visualizedPage),r=(b.default(m.DEBUG_LEVEL,"Computed item: "+r),new w.Subscription(n.mode,r,n.fields));return r.setRequestedSnapshot(!t||t.snapshot?h.default.YES:h.default.NO),r.addListener({onSubscription:e._onSubscription,onSubscriptionError:e._onSubscriptionError,onItemLostUpdates:e._onItemLostUpdates,onClearSnapshot:e._onClearSnapshot,onItemUpdate:function(e){var t=p.remap(e.getValue,e);b.default(m.DEBUG_LEVEL,o+" update ("+i.lsConnectionDetails.getSessionId()+", "+e.isSnapshot()+")",t(h.default.KEY),t("u"),t("i"),t("p"),t("r"),t("s"),t("d")),i.chatManager.handle(e).then(function(e){e&&(b.default(m.DEBUG_LEVEL,"CHAT upds",e),n.updateSnapshot(i.chatManager.get(),i),e.forEach(function(e){e._snap=n.snapshot;e=new L.ChatEvent(e);i.notifySubjectEvent(e)}))}).catch(function(e){b.default(m.DEBUG_LEVEL,e)})}}),r},M.prototype.makeParametersSubscription=function(l,e){var c=this,t=E.default.CONF.scope===h.default.SITE?h.default.GROUP_PLACEHOLDER+"/":""+h.default.MASTER_PLACEHOLDER+this.context.pageCtx,t=l.prefix+":"+t,t=(b.default(m.DEBUG_LEVEL,"Computed item: "+t),new w.Subscription(l.mode,t,l.fields));return t.setRequestedSnapshot(h.default.YES),t.addListener({onSubscription:e._onSubscription,onSubscriptionError:e._onSubscriptionError,onItemLostUpdates:e._onItemLostUpdates,onItemUpdate:function(e){var t=p.remap(e.getValue,e),n=t("ml"),i=t("mlm"),o=t("md"),r=t("cd"),s=t("mh"),t=t("gr");if(b.default(m.DEBUG_LEVEL,l.toString()+" update ("+c.lsConnectionDetails.getSessionId()+", "+e.isSnapshot()+")",n,i,o,r,s,t),null!==n&&null!==i&&null!==o&&null!==r){var e=Number(n),n=Number(i),i=p.messageDurationParser(o),a=void 0;switch(r){case"M":a="DISABLED_BY_MODERATOR";break;case"A":a="DISABLED_BY_ADMINISTRATOR";break;default:a="ENABLED"}var u=void 0;switch(t){case"1":u="G";break;case"2":u="PG";break;case"3":u="PG-13";break;case"4":u="R";break;default:u="DISABLED"}NaN!==e&&NaN!==n&&(o={messageMaxLength:e,messageMaxLengthModerator:n,messageMaxLengthGuest:n,messageDurationValue:i.value,messageDurationUnit:i.unit,chatStatus:a,clickableLinks:"a"===s?"ALL":"INTERNALS",gifsStatus:u},l.updateSnapshot(o,c),r=new L.ParametersEvent(o),c.notifySubjectEvent(r,[0,1]))}}}),t},M.prototype.makeCounterSubscription=function(n,e){var t,i=this,o=n.prefix,r=n.name,s=n.context,a=n.toString();switch(s){case 0:t=r!==A.SubscriptionSubject.COUNTER_CHAT_TYPING&&r!==A.SubscriptionSubject.COUNTER_CHAT_MESSAGES||E.default.CONF.scope!==h.default.SITE?o+":"+this.context.visualizedPage:o+":"+(this.context.groupHomePage||this.context.homePage);break;case 1:t=o+":"+(this.context.groupSiteCtx||this.context.siteCtx);break;case 2:t=o+":"+h.default.GLOBAL_SUB_SUFFIX;break;case 3:t=o+":"+(this.context.siteCtx+n.customContext)}b.default(m.DEBUG_LEVEL,"Computed item: "+t);s=new w.Subscription(n.mode,t,n.fields);return s.setRequestedSnapshot(h.default.YES),s.addListener({onSubscription:e._onSubscription,onSubscriptionError:e._onSubscriptionError,onItemLostUpdates:e._onItemLostUpdates,onItemUpdate:function(e){var t=(t=p.remap(e.getValue,e)(n.fields[0]))&&t.toString();b.default(m.DEBUG_LEVEL,a+" update ("+i.lsConnectionDetails.getSessionId()+", "+e.isSnapshot()+")",t),t!==n.snapshot.value?(n.updateSnapshot(e={value:t},i),t=new L.CounterEvent(r,e),i.notifySubjectEvent(t)):b.default(m.DEBUG_LEVEL,"Discarded counter update",n)}}),s},M.prototype.makeRankingSubscription=function(r,e){var s=this,a=r.toString(),u=r.name,t=r.prefix+":"+(2===r.context?h.default.GLOBAL_SUB_SUFFIX:this.context.groupSiteCtx||this.context.siteCtx),n=(b.default(m.DEBUG_LEVEL,"Computed item: "+t),!1),i=p.cloneObject(r.fields),i=this.analyticsMode?i.concat(["f"]):i,t=new w.Subscription(r.mode,t,i);return t.setRequestedSnapshot(h.default.YES),t.addListener({onSubscription:e._onSubscription,onSubscriptionError:e._onSubscriptionError,onItemLostUpdates:e._onItemLostUpdates,onClearSnapshot:e._onClearSnapshot,onEndOfSnapshot:function(){var e;b.default(m.DEBUG_LEVEL,a+" endOfSnapshot call"),n||(n=!0,e=new L.RankingEvent(u,s.rankingManager.initPayload()),s.notifySubjectEvent(e))},onItemUpdate:function(e){var t=p.remap(e.getValue,e),t=(b.default(m.DEBUG_LEVEL,a+" update ("+s.lsConnectionDetails.getSessionId()+", "+e.isSnapshot()+")",t(h.default.KEY),t(h.default.COMMAND),t("i"),t("t"),t("c"),t("p")),s.rankingManager.handle(r,e));if(t){r.updateSnapshot(s.rankingManager.get(a,!0),s);for(var n=0,i=t;n<i.length;n++){var o=i[n],o=(o._snap=r.snapshot,new L.RankingEvent(u,o));s.notifySubjectEvent(o)}}else b.default(m.DEBUG_LEVEL,"Discarded "+a+" ranking update")}}),t},M.prototype.makeTypingSubscription=function(n,e){var i=this,o=n.toString(),t=n.prefix+":"+(E.default.CONF.scope===h.default.SITE?this.context.groupHomePage||this.context.homePage:this.context.visualizedPage),t=(b.default(m.DEBUG_LEVEL,"Computed item: "+t),new w.Subscription(n.mode,t,n.fields));return t.setRequestedSnapshot(h.default.YES),t.addListener({onSubscription:e._onSubscription,onSubscriptionError:e._onSubscriptionError,onItemLostUpdates:e._onItemLostUpdates,onClearSnapshot:e._onClearSnapshot,onItemUpdate:function(e){var t=p.remap(e.getValue,e);b.default(m.DEBUG_LEVEL,o+" update ("+i.lsConnectionDetails.getSessionId()+", "+e.isSnapshot()+")",t(h.default.KEY),t(h.default.COMMAND)),i.typingManager.handle(e).then(function(e){n.updateSnapshot(i.typingManager.get(),i),e._snap=n.snapshot;e=new L.TypingUsersEvent(e);i.notifySubjectEvent(e)}).catch(function(e){b.default(m.DEBUG_LEVEL,e)})}}),t},M.prototype.makeHeatmapSubscription=function(r,e){var t,s=this,a=r.id,n=r.prefix,u=r.name;switch(r.context){case 0:t=n+":"+this.context.visualizedPage;break;case 1:t=n+":"+(this.context.groupSiteCtx||this.context.siteCtx);break;default:b.default(m.ERROR_LEVEL,"H sub unsupported context")}b.default(m.DEBUG_LEVEL,"Computed item: "+t);var i=new w.Subscription(r.mode,t,r.fields);return i.setRequestedSnapshot(h.default.YES),i.addListener({onSubscription:e._onSubscription,onSubscriptionError:e._onSubscriptionError,onItemLostUpdates:e._onItemLostUpdates,onItemUpdate:function(e){var t=p.remap(e.getValue,e),t=(b.default(m.DEBUG_LEVEL,a+" update ("+s.lsConnectionDetails.getSessionId()+", "+e.isSnapshot()+")",t("c"),t("h")),s.heatmapManager.handle(a,e));if(t){r.updateSnapshot(s.heatmapManager.get(a),s);for(var n=0,i=t;n<i.length;n++){var o=i[n],o=(o._snap=r.snapshot,new L.HeatmapEvent(u,o));s.notifySubjectEvent(o)}}else b.default(m.DEBUG_LEVEL,"Discarded "+a+" update")}}),i},M.prototype.subscribePageForegroundPresenceItem=function(){var e=this.subjects.find(h.default.PRESENCE_FOREGROUND).id,t=this.subs[e];t?(this.lsClient.subscribe(t),b.default(m.DEBUG_LEVEL,"Subscribe "+e)):b.default(m.WARN_LEVEL,"Undefined "+e)},M.prototype.unsubscribePageForegroundPresenceItem=function(){localStorage.setItem("unsubPF",""+new Date);var e=this.subjects.find(h.default.PRESENCE_FOREGROUND).id,t=this.subs[e];t?(this.lsClient.unsubscribe(t),b.default(m.DEBUG_LEVEL,"Unsubscribe "+e)):b.default(m.WARN_LEVEL,"Undefined "+e)},M.prototype.subscribeTypingPresenceItem=function(){var e=this.subjects.find(h.default.PRESENCE_TYPING);return b.default(m.DEBUG_LEVEL,"Subscribe "+e.id),this.subscriptionFactory(e)},M.prototype.unsubscribeTypingPresenceItem=function(){var e=this.subjects.find(h.default.PRESENCE_TYPING).id;this.lsUnsubscribe(e),b.default(m.DEBUG_LEVEL,"Unsubscribe "+e)},M.prototype.makeParametersSub=function(){var e=this.subjects.find(A.SubscriptionSubject.PARAMETERS);this.subscriptionFactory(e),b.default(m.DEBUG_LEVEL,"Subscribe "+e.id)},M.prototype.makeEventsSub=function(){var e=this.subjects.find(h.default.EVENTS);this.subscriptionFactory(e),b.default(m.DEBUG_LEVEL,"Subscribe "+e.id)},M.prototype.respondToProxy=function(e,t,n,i){e=new a.ResponseEvent({id:e,fn:t,res:n,data:i});this.notify(e,"p")},M.prototype.initUserInfoCache=function(){this.userInfoCache||(this.userInfoCache=new W.default,this.subscriptionFactory(this.subjects.find(h.default.MESSAGE_USER_LIST)))},M.prototype.lsUnsubscribe=function(e){this.subs[e]?(this.subs[e].isActive()?this.lsClient.unsubscribe(this.subs[e]):b.default(m.DEBUG_LEVEL,"Already unsubscribed",e),delete this.subs[e]):b.default(m.WARN_LEVEL,"Subscription flow sync error",e,this.subs)},M.prototype.handleSubjectSubscribe=function(i,e,t,n){var o=this,r=null,s=i.category,a=i.toString(),u=i.isSpecial()?void 0===i.listener:void 0===this.subs[a];switch(i.subscribedBy(n.fromProxy?1:0),s){case 3:this.initUserInfoCache(),this.chatManager||(this.chatManager=j.default.getInstance()),u&&(b.default(m.DEBUG_LEVEL,"Initilize subject: "+i),this.chatManager.init(this.getUserInfo.bind(this)),this.chatUpdateFn||(this.chatUpdateFn=this.userInfoCache.watch(f.SharedEvent.UserUpdated,function(e){e=o.chatManager.updateUser(e);if(e.length){b.default(m.DEBUG_LEVEL,"chat list user updates",e),i.updateSnapshot(o.chatManager.get(),o);for(var t=e.map(function(e){return d(d({},e),{_snap:i.snapshot})}),n=0;n<t.length;n++)o.notifySubjectEvent(new L.ChatEvent(t[n]))}})),this.chatSnapshotClearer.activate(),r=this.subscriptionFactory(i,t,null));break;case 6:this.initUserInfoCache(),this.typingManager||(this.typingManager=V.default.getInstance()),u&&(b.default(m.DEBUG_LEVEL,"Initilize subject: "+i),this.typingManager.init(this.getUserInfo.bind(this)),r=this.subscriptionFactory(i,null,null));break;case 2:case 11:case 10:u&&(b.default(m.DEBUG_LEVEL,"Initilize subject: "+i),r=this.subscriptionFactory(i,null,null));break;case 4:void 0===this.rankingManager&&(this.rankingManager=G.default.getInstance()),u&&(b.default(m.DEBUG_LEVEL,"Initilize subject: "+i),this.rankingManager.init(a,this.contextManager,this.analyticsMode),r=this.subscriptionFactory(i,null,null));break;case 5:void 0===this.heatmapManager&&(this.heatmapManager=l.default.getInstance()),u&&(b.default(m.DEBUG_LEVEL,"Initilize subject: "+i),this.heatmapManager.init(a),r=this.subscriptionFactory(i,null,null))}return u&&!i.isSpecial()&&i.initSnapshot(this),n.fromProxy&&(n.fromProxy,p.isFunction(i.listener))||i.setListener(e),null!==r?r:new Promise(function(e){e({}),p.enqueueMicrotask(function(){o.notifySnapshot(i,n.fromProxy)})})},M.prototype.handleSubjectUnsubscribe=function(e,t){var n=e.toString(),i=e.getSubscribers().length,t=t.fromProxy?1:0;return 1===i?(e.unsubscribedBy(t),e.isSpecial()||(this.lsUnsubscribe(n),e.deleteSnapshot(this)),e.isDynamic()?this.subjects.destroy(e):e.resetListener(),e.name===A.SubscriptionSubject.LIST_CHAT_MESSAGES?(this.chatSnapshotClearer.deactivate(),this.chatUpdateFn&&(this.userInfoCache.unwatch(f.SharedEvent.UserUpdated,this.chatUpdateFn),this.chatUpdateFn=null),this.chatManager.abortRunning()):e.name===A.SubscriptionSubject.LIST_CHAT_TYPING&&this.typingManager.abortRunning(),new Promise(function(e){e({})})):(e.unsubscribedBy(t),0==t&&e.resetListener(),Promise.resolve({}))},M.prototype.handleClearSnapshot=function(e){if(e)this.notifyClearSnapshot(e);else for(var t in b.default(m.DEBUG_LEVEL,"Reset snapshot"),this.subs)this.notifyClearSnapshot(this.subjects.findFromId(t))},M.prototype.notifySnapshot=function(t,e){b.default(m.DEBUG_LEVEL,"notifySnapshot",t,e);var n=t.category,i=t.name,o=t.id,r=[e?1:0];if(t.isSpecial())this.notifySubjectEvent(new L.Now4realSubjectUpdate(t.name,t.snapshot),r);else switch(n){case 3:var s=this.chatManager.snapshot().map(function(e){return d(d({},e),{_snap:t.snapshot})});if(0<s.length)for(var a=0;a<s.length;a++)this.notifySubjectEvent(new L.ChatEvent(s[a]),r);break;case 4:var u=this.rankingManager.snapshot(o);if(u.push(this.rankingManager.initPayload()),u.map(function(e){return d(d({},e),{_snap:t.snapshot})}),0<u.length)for(a=0;a<u.length;a++)this.notifySubjectEvent(new L.RankingEvent(i,u[a]),r);break;case 5:var l=this.heatmapManager.snapshot(o).map(function(e){return d(d({},e),{_snap:t.snapshot})});if(0<l.length)for(a=0;a<l.length;a++)this.notifySubjectEvent(new L.HeatmapEvent(i,l[a]),r);break;case 6:var c=this.typingManager.snapshot().map(function(e){return d(d({},e),{_snap:t.snapshot})});if(0<c.length)for(a=0;a<c.length;a++)this.notifySubjectEvent(new L.TypingUsersEvent(c[a]),r);break;case 2:null!==t.snapshot.value&&this.notifySubjectEvent(new L.CounterEvent(i,t.snapshot),r)}},M.prototype.notifyClearSnapshot=function(i){var o=this,e=i.category,t=i.name,r=i.toString();switch(e){case 3:this.chatManager.clearSnapshot().then(function(e){var t=e.map(function(e){return d(d({},e),{_snap:i.initialSnapshot})});if(0<t.length){for(var n=0;n<t.length;n++)o.notifySubjectEvent(new L.ChatEvent(t[n]));i.resetSnapshot(o),b.default(m.DEBUG_LEVEL,"Reset "+r+" subscription")}});break;case 4:var n=this.rankingManager.clearSnapshot(r).map(function(e){return d(d({},e),{_snap:i.initialSnapshot})});if(0<n.length){for(var s=0;s<n.length;s++)this.notifySubjectEvent(new L.RankingEvent(t,n[s]));i.resetSnapshot(this),b.default(m.DEBUG_LEVEL,"Reset "+r+" subscription")}break;case 5:var a=this.heatmapManager.clearSnapshot(r).map(function(e){return d(d({},e),{_snap:i.initialSnapshot})});if(0<a.length){for(s=0;s<a.length;s++)this.notifySubjectEvent(new L.HeatmapEvent(t,a[s]));i.resetSnapshot(this),b.default(m.DEBUG_LEVEL,"Reset "+r+" subscription")}break;case 6:this.typingManager.clearSnapshot().then(function(e){var t=e.map(function(e){return d(d({},e),{_snap:i.initialSnapshot})});if(0<t.length){for(var n=0;n<t.length;n++)o.notifySubjectEvent(new L.TypingUsersEvent(t[n]));i.resetSnapshot(o),b.default(m.DEBUG_LEVEL,"Reset "+r+" subscription")}});break;case 2:null!==i.snapshot.value&&(this.notifySubjectEvent(new L.CounterEvent(t,i.initialSnapshot)),i.resetSnapshot(this),b.default(m.DEBUG_LEVEL,"Reset "+r+" subscription"))}},M.prototype.handleLogout=function(e){b.default(m.DEBUG_LEVEL,"handleLogout call",e=void 0===e?!0:e),4!==g.default.state.actual&&(g.default.state.change(4),e&&(this.noRegistrationMode||this.emailMode?((e=c.default.storagePerSite).removeItem(this.noRegistrationMode?E.default.NO_RE_AUTH_KEY:E.default.EMAIL_AUTH_KEY),e.removeItem(this.noRegistrationMode?E.default.NO_RE_AUTH_MASTER_KEY:E.default.EMAIL_AUTH_MASTER_KEY)):S.default.deleteUser()),e={status:"NOT_AUTHENTICATED"},this.subjects.find(A.SubscriptionSubject.LOGIN_STATUS).updateSnapshot(e,this),this.notifyLogout(e),u.default.publish(f.SharedEvent.Authentication,{authorization:g.default.getAuthorization()}))},M.prototype.handleLogin=function(e){b.default(m.DEBUG_LEVEL,"handleLogin call",e),3!==g.default.state.actual&&g.default.state.change(3);var t=this.subjects.find(A.SubscriptionSubject.LOGIN_STATUS),n=t.snapshot,i=!this.JWTMode||(null==(i=g.default.getUser())?void 0:i.consent),o=!this.JWTMode&&(this.noRegistrationMode?c.default.storagePerSite.isPersistent():!S.default.isSessionMode()),r=g.default.getDetails(),i={status:"AUTHENTICATED",user:p.createCurrentUser(e,i,r?r.role:null,r?r.badge:null,r?r.preferences:null),persistent:o};p.deepEqual(n,i)||(t.updateSnapshot(i,this),this.notifyLogin(i),u.default.publish(f.SharedEvent.Authentication,{user:e,authorization:g.default.getAuthorization()}))},M.prototype.handleUnrecoverableStatus=function(e){var t;for(void 0===e&&(e=!0);this.cleanPile.length;)null!=(t=this.cleanPile.shift())&&t();e&&this.notifyDestroy()},M.prototype._load=function(n){var r,s=this;return b.default(m.INFO_LEVEL,"_load call",arguments),(n=n||location.href)&&p.isString(n)?(r=function(e){return e.startsWith(h.default.HTTP)?e:h.default.HTTP+"://"+e},new Promise(function(i,t){var o=s.contextManager.getSiteContext(r(n));(e=>(s.siteJSONConf=new C.default(e,s.contextManager.getOurOrigin()),("now4real.com"===(e=e)?Promise.resolve('{"s":3,"v":3}'):s.siteJSONConf.fetch(e).then(function(e){return e.responseText})).then(function(e){return s.siteJSONConf.update(e).status})))(o).then(function(e){0!==e?(e=n,document.customReferrer=r(e),s.context=s.contextManager.update(null,null),u.default.subscribe(f.SharedEvent.Load,function(e){var t=s.currentConf,n=t.master;i({siteContext:o,master:n,group:t.group})}),u.default.subscribe(f.SharedEvent.LoadError,function(e){t(e)}),s.start()):(e=new _.default(A.ApiErrorCode.CURRENTLY_DISABLED,"the site is currently disabled"),s.notifyLoadError(e),t(e))}).catch(function(e){e=403===e.statusCode?new _.default(A.ApiErrorCode.INVALID_CALL,"the site is not registered yet"):new _.default(A.ApiErrorCode.TECHNICAL_PROBLEM,e.statusCode);s.notifyLoadError(e),t(e)})})):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,""))},M.prototype.setLoggerLevel=function(e){if(b.default(m.INFO_LEVEL,"setLoggerLevel call",arguments),!e)return Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid level argument"));if(!p.isString(e))return Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"level must be a string"));e=e.toLowerCase().capitalize();if(void 0===v.LoggerLevels[e])return Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid level name"));E.default.LOGGER_LEVEL=v.LoggerLevels[e];e=new a.LoggerEditEvent({level:v.LoggerLevels[e]});return this.notify(e,"p"),this.notify(e,"s"),Promise.resolve({})},M.prototype.subscribe=function(e,t,n,i){var o;return void 0===i&&(i=!1),b.default(m.INFO_LEVEL,"subscribe call",arguments),p.isString(e)?(o=this.subjects.find(e))?!o.isCustom()&&o.name===e||3===this.siteStatus?11!==o.category&&10!==o.category||3===this.siteStatus?o.name!==e?Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"not customizable subject")):i||p.isFunction(t)?!i&&-1<o.getSubscribers().indexOf(0)?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"already subscribed subject")):this.handleSubjectSubscribe(o,t,n,{fromProxy:i}):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"callback must be a function")):Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"poll is a Premium feature")):(o.isCustom()&&this.subjects.destroy(o),Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"custom context is a Premium feature"))):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"subject not exists")):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"subject must be a string"))},M.prototype.unsubscribe=function(e,t){return void 0===t&&(t=!1),b.default(m.INFO_LEVEL,"unsubscribe call",arguments),p.isString(e)?(e=this.subjects.find(e))?!e.isSpecial()&&!e.isSubscribed()||e.isSpecial()&&void 0===e.listener?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"not subscribed subject")):this.handleSubjectUnsubscribe(e,{fromProxy:t}):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"subject not exists")):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"subject must be a string"))},M.prototype.get=function(e){b.default(m.INFO_LEVEL,"get call",arguments);var t=this.subjects.find(e);if(!t||t.name!==e)throw new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid subject");if(t.isSubscribed())return t.snapshot;throw new _.default(A.ApiErrorCode.INVALID_CALL,"not subscribed subject")},M.prototype.editUserProfile=function(){var e,t,n,i;return b.default(m.INFO_LEVEL,"editUserProfile call",arguments),this.JWTMode?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"not supported using custom auth")):(e=this.subjects.find(A.SubscriptionSubject.LOGIN_STATUS).snapshot.user)?(t=this.contextManager.context.siteCtx,n=this._whiteLabel,i=null==(i=this.siteJSONConf.get())?void 0:i.siteKey,g.default.editUserProfile(t,i,e.id,n)):Promise.reject(new _.default(A.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated"))},M.prototype.login=function(e){b.default(m.INFO_LEVEL,"login call",arguments);var t,n,i,o,r=this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS).snapshot.status;return/^DISCONNECTED:/.test(r)?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"the client is on an unrecoverable disconnection status")):this.webViewMode?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"not supported on this browser")):this.JWTMode?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"not supported using custom auth")):3===g.default.state.actual?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"the user is already authenticated")):(r=this.noRegistrationMode,t=this.emailMode,n=this._whiteLabel,r||t||!e||p.isString(e)?r||t||!e||void 0!==f.Social[e]||e===h.default.EMAIL?void 0!==g.default.window?(g.default.window.focus(),Promise.reject(new _.default(A.ApiErrorCode.ALREADY_STARTED,"already opened authentication window"))):(i=this.contextManager.context.siteCtx,o=null==(o=this.siteJSONConf.get())?void 0:o.siteKey,this.loginHandler(r?g.default.startNoRegistration(i,o,n):g.default.startOauth(i,e,o,t,n),t,r)):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid provider name")):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"provider must be a string")))},M.prototype.startProxyLogin=function(){b.default(m.DEBUG_LEVEL,"startProxyLogin");var e=this.noRegistrationMode,t=this.emailMode;return this.loginHandler(g.default.proxyStart(e),t,e)},M.prototype.stopProxyLogin=function(){b.default(m.DEBUG_LEVEL,"stopProxyLogin"),g.default.proxyStop()},M.prototype.loginHandler=function(e,n,i){var t=this;return e.then(function(e){return n||i?c.default.storagePerSite.setItem(n?E.default.EMAIL_AUTH_KEY:E.default.NO_RE_AUTH_KEY,e):S.default.storeUser(e),g.default.storeUserId(e.id),e}).then(function(e){return t.lsConnectionManager.switchToAuthenticated(i?f.ConnectMode.NO_REGISTRATION:n?f.ConnectMode.EMAIL:f.ConnectMode.SOCIAL,i?e.token:e)}).then(function(e){return g.default.reset(),t.lsMessageChannel.invokeGetAuthInfo().then(function(e){return g.default.storeDetails(e)})}).then(function(e){return t.handleLogin(e),e}).then(function(e){var t=g.default.getDetails();return{user:p.createCurrentUser(e,!0,t?t.role:null,t?t.badge:null,t?t.preferences:null),persistent:i||n?c.default.storagePerSite.isPersistent():!S.default.isSessionMode()}}).catch(function(e){throw g.default.reset(),g.default.storeUserId(null),t.handleSwitchError(e),e})},M.prototype.logout=function(){var i,o=this,e=(b.default(m.INFO_LEVEL,"logout call",arguments),this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS).snapshot.status);return/^DISCONNECTED:/.test(e)?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"the client is on an unrecoverable disconnection status")):this.JWTMode?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"not supported using custom auth")):3!==g.default.state.actual?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"already in readOnly state")):(i=g.default.getUserId(),new Promise(function(t,n){var e;g.default.state.change(2),g.default.storeUserId(null),(o.noRegistrationMode?Promise.resolve():(e=o.emailMode?c.default.storagePerSite.getItem(E.default.EMAIL_AUTH_KEY).secret:S.default.retrieveCredentials().userSecret,o.lsMessageChannel.invokeLogout(e))).then(function(e){return o.lsConnectionManager.switchToUnauthenticated()}).then(function(e){g.default.resetDetails()}).then(function(e){return o.lsMessageChannel.invokeGetAuthInfo().then(function(e){return g.default.storeDetails(e)})}).then(function(e){o.handleLogout(!0),t({})}).catch(function(e){o.handleSwitchError(e),g.default.storeUserId(i),n(e)})}))},M.prototype.post=function(e,t,r){var n,i,s=this;return void 0===r&&(r=!1),b.default(m.INFO_LEVEL,"post call",arguments),p.isString(e)?""===e?Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"message can't be empty")):(i=this.subjects.find(A.SubscriptionSubject.PARAMETERS),n=(n=g.default.getDetails())?n.role:null,i=p.getMessageMaxLength(i,n),b.default(m.DEBUG_LEVEL,"using pars: "+i+", "+this.throttlingTimeout),p.countStringSymbols(e)>i?Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"message too long")):"DISCONNECTED"===this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new _.default(A.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):this.subjects.find(A.SubscriptionSubject.LOGIN_STATUS).snapshot.user?null!==this.throttlingTimeout?Promise.reject(new _.default(A.ApiErrorCode.TOO_FREQUENT,"posting rate exceeded, please wait for the required interval")):!this.JWTMode||g.default.getUser().consent||this._whiteLabel?new Promise(function(o,n){s.lsMessageChannel.invokePostMessage(e,t).then(function(e){var t=e.w||0,e=e.s,n=1e3*t,i={waitPeriod:n};e&&(i.suggestions=e),0!==t&&(s.throttlingTimeout=window.setTimeout(function(e){s.throttlingTimeout=null,b.default(m.DEBUG_LEVEL,"Posting re-enabled")},n)),"api+widget"===E.default.CONF.target&&(s._suggestions=t=e||null,r)&&(n=new a.SuggestionsUpdateEvent({suggestions:t}),s.notify(n,"s")),o(i)}).catch(function(e){var t=e;e instanceof _.default||(t="MUTED"===e?new _.default(A.ApiErrorCode.USER_MUTED,"the user is muted"):"SEND_RATE"===e?new _.default(A.ApiErrorCode.TOO_FREQUENT,"the message was posted before resendTimeout has expired"):"MODERATION"===e?new _.default(A.ApiErrorCode.CANNOT_MODERATE,"the automatic content filtering system doesn't respond"):"CHAT_DISABLED"===e?new _.default(A.ApiErrorCode.CHAT_DISABLED,"the chat is currently disabled"):"FILTERED"===e?new _.default(A.ApiErrorCode.BLOCKED,"the message was blocked by an automatic moderation filter as it was deemed inappropriate"):"CHATBOT"===e?new _.default(A.ApiErrorCode.CHATBOT,"an error occurred with the site's chatbot. Please try again"):new _.default(A.ApiErrorCode.TECHNICAL_PROBLEM,"")),n(t)})}):Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"the consent of the current user has not been recorded")):Promise.reject(new _.default(A.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated"))):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"message must be a string"))},M.prototype.deleteMessage=function(e){return e?p.isString(e)?this.subjects.find(A.SubscriptionSubject.LOGIN_STATUS).snapshot.user?"DISCONNECTED"===this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new _.default(A.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):this.lsMessageChannel.invokeDeleteMessage(e):Promise.reject(new _.default(A.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated")):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"msgId must be a string")):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"msgId is required"))},M.prototype.flushChat=function(){var e;return this.subjects.find(A.SubscriptionSubject.LOGIN_STATUS).snapshot.user?(e=g.default.getDetails())&&e.role===h.default.MODERATOR?"DISCONNECTED"===this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new _.default(A.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):this.lsMessageChannel.invokeFlushChat().then(function(e){return{}}):Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"the user is not a MODERATOR")):Promise.reject(new _.default(A.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated"))},M.prototype.setChatEnabled=function(e){var t;return void 0!==e&&p.isBoolean(e)?this.subjects.find(A.SubscriptionSubject.LOGIN_STATUS).snapshot.user?(t=g.default.getDetails())&&t.role===h.default.MODERATOR?"DISCONNECTED"===this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new _.default(A.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):this.lsMessageChannel.invokeChatEnable(e).then(function(e){return{}}):Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"the user is not a MODERATOR")):Promise.reject(new _.default(A.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated")):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid enabled argument"))},M.prototype.getMute=function(e){return b.default(m.INFO_LEVEL,"getMute call",arguments),void 0!==e&&p.isString(e)?this.subjects.find(A.SubscriptionSubject.LOGIN_STATUS).snapshot.user?"DISCONNECTED"===this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new _.default(A.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):this.lsMessageChannel.invokeMuteUserGet(e).then(function(e){return e?{expiration:(e=e.expiration)?new Date(e).getTime():null}:null}):Promise.reject(new _.default(A.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated")):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid userId argument"))},M.prototype.setMute=function(e,t){var n;return b.default(m.INFO_LEVEL,"setMute call",arguments),void 0!==e&&p.isString(e)?void 0===t||null!==t&&!p.isNumber(t)?Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid duration argument")):this.subjects.find(A.SubscriptionSubject.LOGIN_STATUS).snapshot.user?(n=g.default.getDetails())&&n.role===h.default.MODERATOR?"DISCONNECTED"===this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new _.default(A.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):this.lsMessageChannel.invokeMuteUserSet(e,t).then(function(e){return e?{expiration:(e=e.expiration)?new Date(e).getTime():null}:null}):Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"the user is not a MODERATOR")):Promise.reject(new _.default(A.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated")):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid userId argument"))},M.prototype.startTyping=function(){var n=this;return b.default(m.INFO_LEVEL,"startTyping call",arguments),this.subs[this.subjects.find(h.default.PRESENCE_TYPING).toString()]?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"the user has already started to type")):new Promise(function(e,t){n.subscribeTypingPresenceItem().then(function(){e({})}).catch(function(e){t(e)})})},M.prototype.stopTyping=function(){return b.default(m.INFO_LEVEL,"stopTyping call",arguments),this.subs[this.subjects.find(h.default.PRESENCE_TYPING).toString()]?(this.unsubscribeTypingPresenceItem(),Promise.resolve({})):Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"the user has already stopped to type"))},M.prototype.reload=function(e){if(this.analyticsMode)throw new Error("Unsupported feature");var t=null!=(t=null==e?void 0:e.startOpen)&&t,n=null!=(n=null==e?void 0:e.updatedSiteConf)?n:null,e=null==(e=null==e?void 0:e.reloadScriptConf)||e;this.notify(new o.ReloadEvent(t,n,e),"p")},M.prototype.reportMessage=function(e,t,n){b.default(m.INFO_LEVEL,"reportMessage call",arguments);var i="invalid msgId argument",o="invalid reason argument";return void 0!==e&&p.isString(e)?void 0!==t&&p.isString(t)?n&&!p.isString(n)?Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid comment argument")):n&&500<n.length?Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"comment too long")):this.subjects.find(A.SubscriptionSubject.LOGIN_STATUS).snapshot.user?"DISCONNECTED"===this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new _.default(A.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):this.lsMessageChannel.invokeReportChatMessage(e,t,n).catch(function(e){var t=e;throw t=e instanceof _.default?t:"INVALID_MESSAGE_ID"===e?new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,i):"INVALID_REASON"===e?new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,o):"DUPLICATED"===e?new _.default(A.ApiErrorCode.ALREADY_REPORTED,"the user has already reported the msg"):"MUTED"===e?new _.default(A.ApiErrorCode.USER_MUTED,"the user is muted"):new _.default(A.ApiErrorCode.TECHNICAL_PROBLEM,"")}):Promise.reject(new _.default(A.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated")):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,o)):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,i))},M.prototype.registerUserConsent=function(){var e,t=this;return b.default(m.INFO_LEVEL,"registerUserConsent call",arguments),this.JWTMode?(e=g.default.getUser())?e.consent?Promise.resolve({}):"DISCONNECTED"===this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new _.default(A.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):this.lsMessageChannel.invokeUserConsentSet().then(function(e){return g.default.markConsentAccepted(),t.handleLogin(g.default.getUser()),{}}):Promise.reject(new _.default(A.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated")):Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"feature not supported in the current authentication mode"))},M.prototype.createPoll=function(e,t,n){var i;return b.default(m.INFO_LEVEL,"createPoll call",arguments),!e||!p.isString(e)||100<p.countStringSymbols(e)?Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid question argument")):!t||!p.isArray(t)||t.length<2||10<t.length||t.some(function(e){return!p.isString(e)||25<p.countStringSymbols(e)})?Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid answers argument")):void 0===(n=null==n?void 0:n.multipleChoice)||p.isBoolean(n)?3!==this.siteStatus?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"poll is a Premium feature")):this.subjects.find(A.SubscriptionSubject.LOGIN_STATUS).snapshot.user?!(i=g.default.getDetails())||i.role!==h.default.MODERATOR&&i.role!==h.default.GUEST?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"the user is not a MODERATOR or GUEST")):"DISCONNECTED"===this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new _.default(A.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):(t=t.map(function(e){return e.trim()}),this.lsMessageChannel.invokePollNew(e,t,n?t.length:1).catch(function(e){var t=e;throw t=e instanceof _.default?t:"ALREADY_PRESENT"===e?new _.default(A.ApiErrorCode.ALREADY_PRESENT,"there is already an active poll"):"DISABLED"===e?new _.default(A.ApiErrorCode.CHAT_DISABLED,"the chat was disabled by the Administrator"):new _.default(A.ApiErrorCode.TECHNICAL_PROBLEM,"")})):Promise.reject(new _.default(A.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated")):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid options argument"))},M.prototype.closePoll=function(e){var t;return void 0===e&&(e=!1),b.default(m.INFO_LEVEL,"closePoll call",arguments),void 0===e||p.isBoolean(e)?3!==this.siteStatus?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"poll is a Premium feature")):this.subjects.find(A.SubscriptionSubject.LOGIN_STATUS).snapshot.user?!(t=g.default.getDetails())||t.role!==h.default.MODERATOR&&t.role!==h.default.GUEST?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"the user is not a MODERATOR or GUEST")):"DISCONNECTED"===this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new _.default(A.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):this.lsMessageChannel.invokePollClose(e).catch(function(e){var t=e;throw t=e instanceof _.default?t:"NOT_FOUND"===e?new _.default(A.ApiErrorCode.NOT_FOUND,"there is no active poll"):new _.default(A.ApiErrorCode.TECHNICAL_PROBLEM,"")}):Promise.reject(new _.default(A.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated")):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid remove argument"))},M.prototype.sendVote=function(n){return b.default(m.INFO_LEVEL,"sendVote call",arguments),n&&p.isArray(n)&&!n.some(function(e){return!p.isNumber(e)||!n.every(function(e,t){return n.indexOf(e)===t})})?3!==this.siteStatus?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"poll is a Premium feature")):this.subjects.find(A.SubscriptionSubject.LOGIN_STATUS).snapshot.user?"DISCONNECTED"===this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new _.default(A.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):this.lsMessageChannel.invokePollVoteSet(n).catch(function(e){var t=e;throw t=e instanceof _.default?t:"INVALID_VOTE"===e?new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid votes argument"):"NOT_FOUND"===e?new _.default(A.ApiErrorCode.NOT_FOUND,"there is no active poll"):"CLOSED"===e?new _.default(A.ApiErrorCode.CLOSED,"the current poll has already been closed"):"DISABLED"===e?new _.default(A.ApiErrorCode.CHAT_DISABLED,"the chat is currently disabled"):new _.default(A.ApiErrorCode.TECHNICAL_PROBLEM,"")}):Promise.reject(new _.default(A.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated")):Promise.reject(new _.default(A.ApiErrorCode.INVALID_ARGUMENTS,"invalid votes argument"))},M.prototype.getPollVote=function(){return b.default(m.INFO_LEVEL,"getPollVote call",arguments),3!==this.siteStatus?Promise.reject(new _.default(A.ApiErrorCode.INVALID_CALL,"poll is a Premium feature")):this.subjects.find(A.SubscriptionSubject.LOGIN_STATUS).snapshot.user?"DISCONNECTED"===this.subjects.find(A.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new _.default(A.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):this.lsMessageChannel.invokePollVoteGet().then(function(e){return{vote:e.vote||[]}}).catch(function(e){var t=e;throw t=e instanceof _.default?t:"NOT_FOUND"===e?new _.default(A.ApiErrorCode.NOT_FOUND,"there is no active poll"):new _.default(A.ApiErrorCode.TECHNICAL_PROBLEM,"")}):Promise.reject(new _.default(A.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated"))},M);function M(){var t,n=this;this.version="0.106.0-67-gdd02e10",this.subs={},this.throttlingTimeout=null,this.isLoaded=!1,this.subjects=H.default.getInstance(),this.analyticsMode=!1,this.JWTMode=!1,this.noRegistrationMode=!1,this.emailMode=!1,this.webViewMode=!1,this.cleanPile=[],k.default(),this.checkDomain()&&(t=this.readConfiguration(),this.handleGlobal(),this.contextManager=B.default.getInstance(),this.analyticsMode||top===self||this.contextManager.init().then(function(e){if(b.default(m.DEBUG_LEVEL,"Retrieved context",e),n.context=e,n._ourOrigin=n.context.ourOrigin,n._parentOrigin=n.context.parentOrigin,c.default.parentOrigin=n.context.parentOrigin,i.isBot())throw new _.default(A.ApiErrorCode.TECHNICAL_PROBLEM,"Unsupported browser");n.siteJSONConf=new C.default(n.context.siteCtx,n.context.ourOrigin,n.context.gTranslateRemapped),n.siteJSONConf.initialCheck(t).then(function(e){n.start()}).catch(function(e){b.default(m.ERROR_LEVEL,e),n.notifyLoadError(e)})}).catch(function(e){n.notifyLoadError(e)}))}$.Now4real=D}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{1:1,10:10,11:11,12:12,13:13,14:14,15:15,18:18,19:19,2:2,20:20,21:21,23:23,24:24,25:25,26:26,27:27,28:28,3:3,30:30,31:31,32:32,34:34,35:35,36:36,37:37,39:39,41:41,42:42,43:43,44:44,45:45,5:5,6:6,7:7,9:9}],18:[function(e,t,n){var s=this&&this.__assign||function(){return(s=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},o=(Object.defineProperty(n,"__esModule",{value:!0}),e(41)),a=e(1),i=e(7),u=e(2),r=e(43),l=e(45),c=e(44),d=e(35),E=e(2),e=(h.prototype.setAuthListener=function(e){this.mode=e?"nore":"oauth",window.addEventListener("message",this.userAppResponseListener,!1)},h.prototype.resetAuthListener=function(){this.mode=null,window.removeEventListener("message",this.userAppResponseListener)},h.prototype.onError=function(e){this.promise.rejecter(e),this.state.change(this.state.initial),this.state.initial=void 0,this.reset()},h.prototype.getAuthorization=function(){return this.authorization},h.prototype.reset=function(){this.windowInterval&&(clearInterval(this.windowInterval),this.windowInterval=void 0),void 0!==this.window&&(this.window.close(),this.window=void 0),this.promise.reset(),this.resetAuthListener()},h.prototype.proxyStart=function(n){var i=this;return new Promise(function(e,t){i.promise.set(e,t),i.state.initial=i.state.actual,i.state.change(1),i.setAuthListener(n)})},h.prototype.proxyStop=function(){var e,t;null!=(t=(e=this.promise).rejecter)&&t.call(e),this.reset()},h.prototype.startLogin=function(e,t,n){var i=this,e=(void 0===t&&(t=!1),void 0===n&&(n=!0),window.open(e,"login"));return o.popupBlockerChecker(e)?Promise.reject(new r.default(c.ApiErrorCode.BLOCKED,"authentication popup was blocked")):n?(this.window=e,this.state.initial=this.state.actual,this.state.change(1),this.setAuthListener(t),new Promise(function(e,t){i.promise.set(e,t),i.windowInterval=window.setInterval(function(e){try{i.window&&!i.window.opener&&void 0!==a.default.TECHNICAL_CONF.file_name?(d.default(E.DEBUG_LEVEL,"Found communication issue",i.window,i.window.opener),1===i.state.actual&&i.onError(new r.default(c.ApiErrorCode.TECHNICAL_PROBLEM,"cannot access authentication page"))):i.window&&i.window.closed&&(d.default(E.DEBUG_LEVEL,"Auth window closed"),1===i.state.actual)&&i.onError(new r.default(c.ApiErrorCode.ABORTED,"closed authentication window"))}catch(e){d.default(E.ERROR_LEVEL,e)}},a.default.AUTH_WINDOW_CHECK_INTERVAL)})):Promise.resolve({})},h.prototype.getCommonUserAppParams=function(e,t){var n=a.default.CONF.widget,e={site:e,lang:n.language};return!1!==t&&(e.wl=t,e.logo=n.logo_url,e.bgColor=n.color_internal_background),e},h.prototype.editUserProfile=function(e,t,n,i){n=l.computeUserAppURL(a.default.USER_APP_URL,"email-signin/step1",s({action:"EDIT_PROFILE",userId:n,siteKey:t},this.getCommonUserAppParams(e,i)));return this.startLogin(n,!1,!1)},h.prototype.startOauth=function(e,t,n,i,o){var r=a.default.CONF.widget,t=l.computeUserAppURL(a.default.USER_APP_URL,"oauth-signin",s({provider:i?u.default.EMAIL:t,siteKey:i?n:null,cm:i?r.consent_message:null},this.getCommonUserAppParams(e,o)));return this.startLogin(t)},h.prototype.startNoRegistration=function(e,t,n){var i=a.default.CONF.widget,t=l.computeUserAppURL(a.default.USER_APP_URL,"no-registration-signin",s({siteKey:t,cm:i.consent_message},this.getCommonUserAppParams(e,n)));return this.startLogin(t,!0)},h.prototype.markConsentAccepted=function(){this.currentUser=s(s({},this.getUser()),{consent:!0})},h.prototype.storeUserId=function(e){this.currentUserId=e},h.prototype.storeDetails=function(e){d.default(E.DEBUG_LEVEL,"storeDetails",e);var t=e.authentication,n=e.authorization,n=(t&&(this.currentUser=s({icon:null,consent:!0},t),this.currentUserId=t.id),n&&(this.authorization=n),null),i=e.role,t=(i&&(n={role:(i=o.authDetailsParser(i,t&&t.badge,t&&t.badgeFg,t&&t.badgeBg)).role,badge:i.badge}),e.preference);if(t)try{(n=n||{}).preferences=JSON.parse(t)}catch(e){d.default(E.ERROR_LEVEL,e)}return n&&(this.details=n),this.getUser()},h.prototype.resetDetails=function(){d.default(E.DEBUG_LEVEL,"resetDetails"),this.currentUser=null,this.details=null,this.authorization=null,this.currentUserId=null},h.prototype.updateRole=function(e,t){d.default(E.DEBUG_LEVEL,"updateRole",e,t);var n=this.details||{};e?(n.role=e,n.badge=t):(delete n.role,delete n.badge),Object.keys(n).length?this.details=n:this.details=null},h.prototype.updatePreferences=function(e){d.default(E.DEBUG_LEVEL,"updatePreferences",e);var t=this.details||{};e?t.preferences=e:delete t.preferences,Object.keys(t).length?this.details=t:this.details=null},h.prototype.getUser=function(){return this.currentUser&&o.cloneObject(this.currentUser)},h.prototype.getUserId=function(){return this.currentUserId},h.prototype.getDetails=function(){return this.details&&o.cloneObject(this.details)},h);function h(){var n=this;this.state={initial:void 0,actual:0,change:function(e){this.actual=e}},this.lsMessageChannel=void 0,this.bandwidthReducer=void 0,this.window=void 0,this.windowInterval=void 0,this.promise={resolver:void 0,rejecter:void 0,set:function(e,t){this.resolver=e,this.rejecter=t},reset:function(){this.rejecter=this.resolver=void 0}},this.currentUserId=null,this.userAppResponseListener=function(e){var t=a.default.TECHNICAL_CONF.our_origin;e.origin===t&&e&&e.data&&e.data.fn===n.mode+".callback"&&e.data.payload&&(d.default(E.DEBUG_LEVEL,"userAppResponseListener",e.data),n.state.change(2),i.default.bandwidthReducer.isFired()&&i.default.bandwidthReducer.restartListening(),n.windowInterval&&(clearInterval(n.windowInterval),n.windowInterval=void 0),n.promise.resolver(e.data.payload))}}n.default=new e},{1:1,2:2,35:35,41:41,43:43,44:44,45:45,7:7}],19:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e(1),o=e(41),r=e(5),s=e(3),a=e(35),u=e(2),e=(l.prototype.init=function(e){var t=this,e=e.authorization;this.state=this.computeState(e),(null==(e=null==(e=i.default.CONF)?void 0:e.custom_auth)?void 0:e.enabled)||r.default.subscribe(s.SharedEvent.Authentication,function(e){e=t.computeState((null==e?void 0:e.authorization)||{});o.deepEqual(t.state,e)||(t.state=e,o.isFunction(t.onUpdateCallback)&&t.onUpdateCallback(e))})},l.prototype.onUpdate=function(e){this.onUpdateCallback=e},l.prototype.getActivePerms=function(){return o.cloneObject(this.perms)},l.prototype.storeActivePerms=function(e,t,n,i){var o=[];e&&o.push("chatR"),t&&o.push("chatW"),n&&o.push("siteR"),i&&o.push("pageR"),this.perms=o},l.prototype.computeState=function(e){function t(e){return!1!==e}a.default(u.DEBUG_LEVEL,"computeState",e);var n=t(e.chatR),i=t(e.chatW),o=t(e.siteR),e=t(e.pageR);return this.storeActivePerms(n,i,o,e),{chatView:n,chatPost:i,siteCounterView:o,pageCounterView:e}},l);function l(){}n.default=new e},{1:1,2:2,3:3,35:35,41:41,5:5}],20:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e(1),o=e(10),u=e(41),l=e(43),c=e(44),d=i.default.BROWSER_PREFERENCES_MASTER_KEY,E=e(35),h=e(2);function r(e){this.site=e,this.clean()}r.prototype.isStorageUsable=function(){return i.default.LOCAL_PERSISTENCE&&o.isStorageAvailable()},r.prototype.getCurrent=function(){try{return JSON.parse(localStorage.getItem(d)||"{}")}catch(e){return E.default(h.ERROR_LEVEL,"error parsing browser preferences",e),{}}},r.prototype.clean=function(){if(this.isStorageUsable()){var e=this.getCurrent(),t=Object.keys(e);if(t.length){for(var n=0,i=t;n<i.length;n++){var o=i[n],r=e[o]||{},s=Object.keys(r);if(s.length){for(var a=0,u=s;a<u.length;a++){var l=u[a],c=r[l];c.exp&&Date.now()>c.exp&&delete r[l]}Object.keys(r).length||delete e[o]}}Object.keys(e).length?localStorage.setItem(d,JSON.stringify(e)):localStorage.removeItem(d)}}},r.prototype.getItem=function(o){var r=this;return new Promise(function(e,t){if(o&&u.isString(o)){if(r.isStorageUsable()){var n=r.getCurrent(),i=n[r.site];if(E.default(h.DEBUG_LEVEL,"browserPreferences.getItem",n,i),i){n=i[o];if(n){i=n.exp,n=n.val;if(!i||Date.now()<=i)return void e(n)}}}e(null)}else t(new l.default(c.ApiErrorCode.INVALID_ARGUMENTS,"key must be a string"))})},r.prototype.setItem=function(o,r,s){var a=this;return new Promise(function(e,t){var n,i;o&&u.isString(o)?void 0!==r&&(u.isString(r)||u.isNumber(r)||u.isBoolean(r))?void 0===s||u.isNumber(s)?(a.isStorageUsable()&&(n=a.getCurrent(),i={val:r},s&&(i.exp=Date.now()+s),E.default(h.DEBUG_LEVEL,"browserPreferences.setItem",n,n[a.site],i),n[a.site]=n[a.site]||{},n[a.site][o]=i,localStorage.setItem(d,JSON.stringify(n))),e()):t(new l.default(c.ApiErrorCode.INVALID_ARGUMENTS,"expirationInMs must be a number")):t(new l.default(c.ApiErrorCode.INVALID_ARGUMENTS,"value must be a string, a number or a boolean")):t(new l.default(c.ApiErrorCode.INVALID_ARGUMENTS,"key must be a string"))})},r.prototype.removeItem=function(o){var r=this;return new Promise(function(e,t){var n,i;o&&u.isString(o)?r.isStorageUsable()?(i=(n=r.getCurrent())[r.site],E.default(h.DEBUG_LEVEL,"browserPreferences.removeItem",n,i),i&&void 0!==i[o]&&(delete i[o],Object.keys(i).length||delete n[r.site],Object.keys(n).length?localStorage.setItem(d,JSON.stringify(n)):localStorage.removeItem(d),e())):e():t(new l.default(c.ApiErrorCode.INVALID_ARGUMENTS,"key must be a string"))})},n.default=r},{1:1,10:10,2:2,35:35,41:41,43:43,44:44}],21:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e(2),o=e(10),r=e(41),s=e(35),a=e(2),e=(u.prototype.isSessionMode=function(){return this.sessionMode},u.prototype.fallbackToSessionMode=function(){this.sessionMode=!0,s.default(a.DEBUG_LEVEL,"SwitchToSessionMode call")},u.prototype.checkCredentialsExistence=function(){return o.isStorageAvailable()||this.sessionMode?this.sessionMode?null!==this.sessionLoginObj:!!localStorage.getItem(i.default.STORAGE_LOGIN_KEY):null},u.prototype.retrieveCredentials=function(){if(this.sessionMode)return{userId:this.sessionLoginObj.id,userSecret:this.sessionLoginObj.secret||null};try{var e=JSON.parse(localStorage.getItem(i.default.STORAGE_LOGIN_KEY));return{userId:e.id,userSecret:e.secret}}catch(e){return null}},u.prototype.storeUser=function(e,t){void 0===t&&(t=!1),this.sessionMode||o.isStorageAvailable()&&!t||this.fallbackToSessionMode(),this.sessionMode?this.sessionLoginObj=e:localStorage.setItem(i.default.STORAGE_LOGIN_KEY,JSON.stringify(e)),s.default(a.DEBUG_LEVEL,"User information stored (for_session="+this.sessionMode+")",e)},u.prototype.addOrUpdateControlLink=function(e){o.isStorageAvailable()&&(localStorage.setItem(i.default.STORAGE_CONTROL_LINK_KEY,JSON.stringify({val:e,exp:Date.now()+36e5})),s.default(a.DEBUG_LEVEL,"control link stored",e))},u.prototype.getControlLink=function(){if(o.isStorageAvailable())try{var e=localStorage.getItem(i.default.STORAGE_CONTROL_LINK_KEY),t=e&&JSON.parse(e);if(t){if(Date.now()<t.exp)return t.val;this.deleteControlLink()}}catch(e){s.default(a.ERROR_LEVEL,"error parsing control link",e),this.deleteControlLink()}return null},u.prototype.deleteControlLink=function(){o.isStorageAvailable()&&localStorage.removeItem(i.default.STORAGE_CONTROL_LINK_KEY)},u.prototype.deleteUser=function(){this.sessionMode?this.sessionLoginObj=null:localStorage.removeItem(i.default.STORAGE_LOGIN_KEY),s.default(a.DEBUG_LEVEL,"DeleteCredential call")},u.prototype.getUser=function(){return this.checkCredentialsExistence()?this.sessionMode?this.sessionLoginObj:JSON.parse(localStorage.getItem(i.default.STORAGE_LOGIN_KEY)):null},u.prototype.updateUser=function(e,t){if(this.checkCredentialsExistence()){var n=void 0;if((n=this.sessionMode?this.sessionLoginObj:JSON.parse(localStorage.getItem(i.default.STORAGE_LOGIN_KEY)))&&(n.nick!==e||n.icon!==t))return n.nick=e,n.icon=t,this.storeUser(n),s.default(a.DEBUG_LEVEL,"User info updated",n),!0}return!1},u.prototype.watch=function(n,i){var e;return this.sessionMode?null:(e=function(e){var t;e.key===n&&(t=JSON.parse(e.newValue||null),e=JSON.parse(e.oldValue||null),r.deepEqual(t,e)||null!=i&&i(t,e))},window.addEventListener("storage",e),function(){window.removeEventListener("storage",e)})},u);function u(){this.sessionMode=!1,this.sessionLoginObj=null}n.default=new e},{10:10,2:2,35:35,41:41}],22:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var r=e(41),i=e(1),o=e(10),s=e(35),a=e(2);function u(e){this.siteKey=e,this.isStorageUsable()||(this.inMemoryBucket={}),s.default(a.DEBUG_LEVEL,"StoragePerSite init",e,!!this.inMemoryBucket)}u.prototype.isStorageUsable=function(){return i.default.LOCAL_PERSISTENCE&&o.isStorageAvailable()},u.prototype.getCurrent=function(){if(this.inMemoryBucket)return this.inMemoryBucket;try{return JSON.parse(localStorage.getItem(this.siteKey)||"{}")}catch(e){return s.default(a.ERROR_LEVEL,"error parsing bucket for: "+this.siteKey,e),{}}},u.prototype.getSiteKey=function(){return this.siteKey},u.prototype.getItem=function(e){return this.getCurrent()[e]},u.prototype.setItem=function(e,t){var n=this.getCurrent();return n[e]=t,this.inMemoryBucket||localStorage.setItem(this.siteKey,JSON.stringify(n)),t},u.prototype.removeItem=function(e){var t=this.getCurrent();delete t[e],this.inMemoryBucket||(Object.keys(t).length?localStorage.setItem(this.siteKey,JSON.stringify(t)):localStorage.removeItem(this.siteKey))},u.prototype.watch=function(n,i){var e,o=this;return this.inMemoryBucket?null:(e=function(e){var t;e.key===o.siteKey&&(t=null==(t=JSON.parse(e.newValue||null))?void 0:t[n],e=null==(e=JSON.parse(e.oldValue||null))?void 0:e[n],r.deepEqual(t,e)||null!=i&&i(t,e))},window.addEventListener("storage",e),function(){window.removeEventListener("storage",e)})},u.prototype.isPersistent=function(){return!this.inMemoryBucket},n.default=u},{1:1,10:10,2:2,35:35,41:41}],23:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e(40),o=e(3),r=e(41),s=e(35),a=e(2);function u(){this.userInfoMap={},this.bus=new i.default}u.prototype.get=function(e){return this.userInfoMap[e]},u.prototype.set=function(e){var t=e.id,n=!!this.userInfoMap[t],i=n&&r.deepEqual(e,this.userInfoMap[t]);this.userInfoMap[t]=e,this.bus.publish(t,e),n?i||(this.bus.publish(o.SharedEvent.UserUpdated,e),s.default(a.DEBUG_LEVEL,"Updated details for user with id: "+t)):s.default(a.DEBUG_LEVEL,"Saved details for user with id: "+t)},u.prototype.watch=function(e,t){return this.bus.subscribe(e,t),s.default(a.DEBUG_LEVEL,"Suscribed "+e+" topic"),t},u.prototype.unwatch=function(e,t){this.bus.unsubscribe(e,t),s.default(a.DEBUG_LEVEL,"Unsuscribed "+t+" from "+e+" topic")},n.default=u},{2:2,3:3,35:35,40:40,41:41}],24:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var r=e(41),s=e(18),a=e(43),u=e(44),l=e(35),c=e(2);function i(e,t,n){this.lsMessageChannel=e,this.subjectsRetriever=t,this.onUpdateListener=n}i.prototype.getCurrentPreferences=function(e){var t=s.default.getDetails();return t&&t.preferences?e?t.preferences[e]||null:t.preferences:null},i.prototype.emitUpdate=function(){var e=s.default.getUser();r.isFunction(this.onUpdateListener)&&this.onUpdateListener(e)},i.prototype.getItem=function(e){var t;return l.default(c.INFO_LEVEL,"userPreferences.getItem call",arguments),void 0===e?Promise.reject(new a.default(u.ApiErrorCode.INVALID_ARGUMENTS,"invalid key argument")):r.isString(e)?(t=this.subjectsRetriever()).find(u.SubscriptionSubject.LOGIN_STATUS).snapshot.user?"DISCONNECTED"===t.find(u.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new a.default(u.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):Promise.resolve(this.getCurrentPreferences(e)):Promise.reject(new a.default(u.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated")):Promise.reject(new a.default(u.ApiErrorCode.INVALID_ARGUMENTS,"key must be a string"))},i.prototype.setItem=function(e,t){var n,i,o=this;return l.default(c.INFO_LEVEL,"userPreferences.setItem call",arguments),void 0===e?Promise.reject(new a.default(u.ApiErrorCode.INVALID_ARGUMENTS,"invalid key argument")):r.isString(e)?void 0===t?Promise.reject(new a.default(u.ApiErrorCode.INVALID_ARGUMENTS,"invalid value argument")):(n=this.subjectsRetriever()).find(u.SubscriptionSubject.LOGIN_STATUS).snapshot.user?"DISCONNECTED"===n.find(u.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new a.default(u.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):((i=this.getCurrentPreferences()||{})[e]=t,this.lsMessageChannel.invokeUserPreferenceSet(JSON.stringify(i)).then(function(e){s.default.updatePreferences(i),o.emitUpdate()}).catch(function(e){var t=e;throw t=e instanceof a.default?t:"VALUE_TOO_LONG"===e?new a.default(u.ApiErrorCode.QUOTA_EXCEEDED,"not enough remaining space for writing this key"):new a.default(u.ApiErrorCode.TECHNICAL_PROBLEM,"")})):Promise.reject(new a.default(u.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated")):Promise.reject(new a.default(u.ApiErrorCode.INVALID_ARGUMENTS,"key must be a string"))},i.prototype.removeItem=function(e){var t,n,i=this;return l.default(c.INFO_LEVEL,"userPreferences.removeItem call",arguments),void 0===e?Promise.reject(new a.default(u.ApiErrorCode.INVALID_ARGUMENTS,"invalid key argument")):r.isString(e)?(t=this.subjectsRetriever()).find(u.SubscriptionSubject.LOGIN_STATUS).snapshot.user?"DISCONNECTED"===t.find(u.SubscriptionSubject.CONNECTION_STATUS).snapshot.status?Promise.reject(new a.default(u.ApiErrorCode.DISCONNECTED,"the client is disconnected from the server")):(delete(n=this.getCurrentPreferences()||{})[e],this.lsMessageChannel.invokeUserPreferenceSet(Object.keys(n).length?JSON.stringify(n):null).then(function(e){s.default.updatePreferences(Object.keys(n).length?n:null),i.emitUpdate()})):Promise.reject(new a.default(u.ApiErrorCode.NOT_AUTHENTICATED,"the user is not authenticated")):Promise.reject(new a.default(u.ApiErrorCode.INVALID_ARGUMENTS,"key must be a string"))},n.default=i},{18:18,2:2,35:35,41:41,43:43,44:44}],25:[function(e,t,n){var l=this&&this.__assign||function(){return(l=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},h=(Object.defineProperty(n,"__esModule",{value:!0}),e(35)),f=e(2),p=e(41),d=e(2),i=e(1),S=e(18),o=e(40),r=e(38);function s(){this.taskQueue=new r.default(!0,1e4,"cm")}s.getInstance=function(){return s.instance=s.instance?s.instance:new s},s.prototype.init=function(t){if(this.chatList=[],this.getUserInfo=t,this.outdatedMsgsMap={},this.msgBus=new o.default,"api"!==i.default.CONF.target){t="(?:[\\u{1F1E6}-\\u{1F1FF}]{2}|\\u{1F3F4}.{1,10}\\u{E007F}|(?:[\\p{Emoji_Presentation}\\p{Other_Symbol}]\\uFE0F?|[\\p{Letter}\\p{Number}\\p{Symbol}\\p{Punctuation}]\\uFE0F)[\\p{Emoji_Modifier}\\p{Enclosing_Mark}]*(?:\\u200D[\\p{Emoji}\\p{Number}\\p{Symbol}\\p{Punctuation}\\p{Enclosing_Mark}]\\uFE0F?\\p{Emoji_Modifier}*)*)";try{this.emojiRegex=new RegExp(t+"(?<!\\uFE0E)","gu")}catch(e){h.default(f.ERROR_LEVEL,"Error parsing emoji regex",e),this.emojiRegex=new RegExp(t,"gu")}}},s.prototype.get=function(){return this.chatList},s.prototype.resolveMessage=function(n){var i=this;return new Promise(function(t){for(var e=0;e<i.chatList.length;e++)if(i.chatList[e].id===n)return h.default(f.DEBUG_LEVEL,"msg resolved from snapshot",i.chatList[e]),void t(i.chatList[e]);i.outdatedMsgsMap[n]?(h.default(f.DEBUG_LEVEL,"msg resolved from outdates",i.outdatedMsgsMap[n]),t(i.outdatedMsgsMap[n])):i.msgBus.subscribe(n,function(e){h.default(f.DEBUG_LEVEL,"msg resolved",e),t(e)})})},s.prototype.handle=function(e){var t,n=this,e=p.remap(e.getValue,e),i=e(d.default.COMMAND),o=e(d.default.KEY),r=e("i"),s=e("u"),a=e("p"),u=e("s"),l=e("r"),c=e("d");switch(h.default(f.DEBUG_LEVEL,"Chat handle "+i+" "+o,this.taskQueue.getPendingCount()),i){case d.default.ADD:return"o"!==u?(t=[this.getUserInfo(s)],l&&t.push(this.resolveMessage(l)),this.taskQueue.add(function(e){return Promise.all(t)}).then(function(e){return n.addToList(o,r,a,c,e[0],e[1])})):this.taskQueue.add(function(e){return n.getUserInfo(s)}).then(function(e){return n.addToOutdatedMap(o,r,a,c,e)});case d.default.DELETE:return this.taskQueue.add(function(e){return n.resolveMessage(o)}).then(function(e){return n.removeFromList(o,!0)});case d.default.UPDATE:return"o"===u?this.taskQueue.add(function(e){return n.resolveMessage(o)}).then(function(e){return n.removeFromList(o,!1)}):this.taskQueue.add(function(e){return n.resolveMessage(o)}).then(function(e){return n.updateList(e,c,a)})}},s.prototype.generateMessage=function(e,t,n,i,o,r){var s,a=S.default.getUserId();if(!n)switch(i){case"u":s="BY_AUTHOR";break;case"d":s="BY_ADMINISTRATOR";break;case"m":s="BY_MODERATOR";break;case"n":s="BY_NOW4REAL";break;case"r":s="BY_AI";break;default:s="UNKNOWN"}i={id:e,author:o||null,message:n||null,time:p.parseTimestamp(t),isMine:o?o.id===a:null};if(s&&(i.deleted=s),r&&(i.repliesTo=r),n&&this.emojiRegex)try{for(var u=n.matchAll(this.emojiRegex),l=n,c=0,d=u.next();!d.done;){var E=d.value[0];if(c+=1,l=l.replace(E,""),3<c)break;d=u.next()}0<c&&c<4&&!l.trim().length&&(i.emojisCount=c)}catch(e){h.default(f.ERROR_LEVEL,"match error",e)}return i},s.prototype.addToOutdatedMap=function(e,t,n,i,o){t=this.generateMessage(e,t,n,i,o);return this.outdatedMsgsMap[e]=t,this.msgBus.publish(e,t),this.msgBus.unsubscribeAll(e),null},s.prototype.addToList=function(e,t,n,i,o,r){var s=this.generateMessage(e,t,n,i,o,r);if(0===this.chatList.length)h.default(f.DEBUG_LEVEL,"insert "+e+" at head",this.chatList.length),this.chatList.push(s);else for(var a=this.chatList.length-1;0<=a;a--){if(s.time>=this.chatList[a].time){h.default(f.DEBUG_LEVEL,"insert "+e+" at index "+(a+1),this.chatList.length),this.chatList.splice(a+1,0,s);break}0===a&&(h.default(f.DEBUG_LEVEL,"insert "+e+" at head",this.chatList.length),this.chatList.unshift(s))}return this.msgBus.publish(e,s),this.msgBus.unsubscribeAll(e),[l({action:"ADD"},s)]},s.prototype.readdToList=function(e){var t=e,n=t.id;if(0===this.chatList.length)h.default(f.DEBUG_LEVEL,"reinsert "+n+" at head",this.chatList.length),this.chatList.push(t);else for(var i=this.chatList.length-1;0<=i;i--){if(t.time>=this.chatList[i].time){h.default(f.DEBUG_LEVEL,"reinsert "+n+" at index "+(i+1),this.chatList.length),this.chatList.splice(i+1,0,t);break}0===i&&(h.default(f.DEBUG_LEVEL,"reinsert "+n+" at head",this.chatList.length),this.chatList.unshift(t))}return this.msgBus.publish(n,t),this.msgBus.unsubscribeAll(n),delete this.outdatedMsgsMap[n],[l({action:"ADD"},t)]},s.prototype.removeFromList=function(e,t){for(var n=0;n<this.chatList.length;n++){var i=this.chatList[n];if(e===i.id){t?delete this.outdatedMsgsMap[e]:this.outdatedMsgsMap[e]=i,this.chatList.splice(n,1);break}}var o=this.generateMessage(e,null,null,null,null);return[l({action:"REMOVE"},o)]},s.prototype.updateList=function(e,t,n){for(var i=-1,o=0;o<this.chatList.length;o++)if(e.id===this.chatList[o].id){i=o;break}if(-1===i)return this.readdToList(e);if(e.moderated||n)return[];for(var r=this.chatList[i],s=this.generateMessage(r.id,r.time.toString(16),null,t,r.author,null),a=(this.chatList.splice(i,1,s),[l({action:"UPDATE"},s)]),o=0;o<this.chatList.length;o++){var u=this.chatList[o];u.repliesTo&&u.repliesTo.id===r.id&&(u.repliesTo=s,this.chatList.splice(o,1,u),a.push(l({action:"UPDATE"},u)))}return a},s.prototype.updateUser=function(e){for(var t=[],n=0;n<this.chatList.length;n++){var i=this.chatList[n],o=p.cloneObject(i),r=!1;i.author.id===e.id&&(o.author=e,r=!0),i.repliesTo&&i.repliesTo.id===e.id&&(o.repliesTo.author=e,r=!0),r&&(this.chatList.splice(n,1,o),t.push(l({action:"UPDATE"},o)))}return t},s.prototype.clearSnapshot=function(){var o=this;this.taskQueue.abortRunning();return this.taskQueue.add(function(e){return Promise.resolve((()=>{for(var e=o.get(),t=[],n=0;n<e.length;n++){var i=o.generateMessage(e[n].id,null,null,null,null);t.push(l({action:"REMOVE"},i))}return o.chatList=[],o.outdatedMsgsMap={},t})())})},s.prototype.snapshot=function(){for(var e=this.get(),t=[],n=0;n<e.length;n++)t.push(l({action:"ADD"},e[n]));return t},s.prototype.abortRunning=function(){this.taskQueue.abortRunning()},n.default=s},{1:1,18:18,2:2,35:35,38:38,40:40,41:41}],26:[function(e,t,n){var u=this&&this.__assign||function(){return(u=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},l=(Object.defineProperty(n,"__esModule",{value:!0}),e(35)),c=e(2),d=e(41);function i(){this.maps={}}i.getInstance=function(){return i.instance=i.instance?i.instance:new i},i.prototype.init=function(e){this.maps[e]={},l.default(c.DEBUG_LEVEL,"Initialized "+e+" heatmap")},i.prototype.get=function(e){return this.maps[e]},i.prototype.handle=function(t,e){var n,i,o,r=this,e=d.remap(e.getValue,e),s=e("c"),e=e("h"),a=[];return s&&e?(n=u({},this.maps[t]),i=d.decodeHeatmap(s,e),l.default(c.DEBUG_LEVEL,"handle "+t+" heatmap",s,e,i),(o=Object.keys(i)).length&&o.forEach(function(e){r.maps[t][e]=i[e],a.push({country:e,intensity:i[e]}),delete n[e]}),(s=Object.keys(n)).length&&(l.default(c.DEBUG_LEVEL,"missing on "+t+" heatmap",s),s.forEach(function(e){delete r.maps[t][e],a.unshift({country:e,intensity:0})}))):(o=Object.keys(this.maps[t])).length&&o.forEach(function(e){delete r.maps[t][e],a.push({country:e,intensity:0})}),a},i.prototype.clearSnapshot=function(e){var t,n=[];for(t in this.get(e))n.push({country:t,intensity:null});return this.maps[e]={},n},i.prototype.snapshot=function(e){var t,n=this.get(e),i=[];for(t in n)i.push({country:t,intensity:n[t]});return i},n.default=i},{2:2,35:35,41:41}],27:[function(e,t,n){var c=this&&this.__assign||function(){return(c=Object.assign||function(e){for(var t,n=1,i=arguments.length;n<i;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)},d=(Object.defineProperty(n,"__esModule",{value:!0}),e(35)),E=e(2),h=e(41),u=e(2),a=e(1);function i(){this.rankingList={}}i.getInstance=function(){return i.instance=i.instance?i.instance:new i},i.prototype.init=function(e,t,n){this.rankingList[e]={map:{},buffer:{}},d.default(E.DEBUG_LEVEL,"Initialized "+e+" ranking"),this.contextManager=t,this.analyticsMode=n},i.prototype.get=function(e,t){void 0===t&&(t=!1);var n,i=[],o=this.rankingList[e].map;for(n in o){var r=h.cloneObject(o[n]);t&&delete r.position,i[o[n].position-1]=r}return i},i.prototype.handle=function(e,t){var n=h.remap(t.getValue,t),i=e.id,o=n(u.default.COMMAND),r=n(u.default.KEY),s=this.extractItem(t,e),a=this.rankingList[i].buffer;switch(o){case u.default.ADD:a[r]=s,d.default(E.DEBUG_LEVEL,r+" ranking: adding "+r);break;case u.default.UPDATE:a[r]=s,d.default(E.DEBUG_LEVEL,r+" ranking: updating "+r);break;case u.default.DELETE:delete a[r],d.default(E.DEBUG_LEVEL,r+" ranking: deleting "+r)}if(this.checkConsistency(i)){n=this.diff(i);if(n)return this.rankingList[i].map=h.cloneObject(a),n}return null},i.prototype.diff=function(e){var t,n=this.rankingList[e].buffer,i=this.rankingList[e].map,o=0,r=0,s=0,a=[];for(t in i)void 0===n[t]&&(o++,a.push(c({action:"LEAVE",key:i[t].key,position:null,users:i[t].users,title:i[t].title,url:i[t].url,isCurrentPage:i[t].isCurrentPage},this.analyticsMode&&{favicon:i[t].favicon})));for(t in n){var u=h.cloneObject(n[t]),l=i[t];void 0===l?(r++,u.action="ENTER",a.push(u)):h.deepEqual(l,u)||(s++,u.action="UPDATE",a.push(u))}return d.default(E.DEBUG_LEVEL,"Diff "+e+" ranking: "+r+" add, "+s+" upd, "+o+" del",n,i),a},i.prototype.checkConsistency=function(e){for(var t=this.rankingList[e].buffer,e=Object.keys(t),n=e.length,i=e.map(function(e){return t[e].position}),o=1;o<=n;o++)if(-1===i.indexOf(o))return!1;return!0},i.prototype.extractItem=function(e,t){var n,e=h.remap(e.getValue,e),i=e(u.default.COMMAND),o=e(u.default.KEY),r=e("i")?Number(e("i"))+1:"",s={};return(s[u.default.KEY]=o).startsWith(a.default.SANDBOX_SITE_CONTEXT)?(s.url=null,s.title=2===t.context?"Now4real Shared Public Sandbox":"Now4real Sandbox: "+o.substring(a.default.SANDBOX_SITE_CONTEXT.length)):(t=("s"===e("p")?"https":"http")+"://"+o,n=e("t"),s.url=t,n?s.title=n:(n=h.parseUrl(t),s.title=n.pathname+n.search+n.hash)),s.users=e("c"),s.position=r,s.isCurrentPage=this.contextManager.isVisualizedPage(o),this.analyticsMode&&(s.favicon=e("f")),i===u.default.DELETE&&(s.url=s.title=s.users="",this.analyticsMode)&&(s.favicon=""),s},i.prototype.initPayload=function(){return c({action:"INIT",key:null,position:null,users:null,title:null,url:null,isCurrentPage:null},this.analyticsMode&&{favicon:null})},i.prototype.clearSnapshot=function(e){for(var t=this.get(e),n=[],i=0;i<t.length;i++)n.push(c({action:"LEAVE",key:t[i].key,position:null,users:null,title:null,url:null,isCurrentPage:null},this.analyticsMode&&{favicon:null}));return this.rankingList[e]={map:{},buffer:{}},n},i.prototype.snapshot=function(e){for(var t=this.get(e),n=[],i=0;i<t.length;i++)n.push(c({action:"ENTER"},t[i]));return n},n.default=i},{1:1,2:2,35:35,41:41}],28:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var o=e(35),r=e(2),s=e(41),a=e(2),i=e(38);function u(){this.taskQueue=new i.default(!0,1e4,"tm"),this.typingUsers={}}u.getInstance=function(){return u.instance=u.instance?u.instance:new u},u.prototype.init=function(e){this.getUserInfo=e,this.typingUsers={},o.default(r.DEBUG_LEVEL,"Initialized typing")},u.prototype.get=function(){var t=this;return Object.keys(this.typingUsers).map(function(e){return t.typingUsers[e]})},u.prototype.handle=function(e){var t=this,e=s.remap(e.getValue,e),n=e(a.default.COMMAND),i=e(a.default.KEY);switch(o.default(r.DEBUG_LEVEL,"Typing handle "+n+" "+i,this.taskQueue.getPendingCount()),n){case a.default.ADD:return this.taskQueue.add(function(e){return t.getUserInfo(i)}).then(function(e){return o.default(r.DEBUG_LEVEL,"Adding "+i+" to typing"),t.typingUsers[i]=e}).then(function(e){return{action:"START",user:e}});case a.default.DELETE:return this.taskQueue.add(function(e){return t.getUserInfo(i)}).then(function(e){return o.default(r.DEBUG_LEVEL,"Deleting "+i+" from typing"),delete t.typingUsers[i],e}).then(function(e){return{action:"STOP",user:e}});default:return Promise.reject("Unsupported typing command")}},u.prototype.clearSnapshot=function(){var o=this;this.taskQueue.abortRunning();return this.taskQueue.add(function(e){return Promise.resolve((()=>{for(var e=[],t=0,n=o.get();t<n.length;t++){var i=n[t];e.push({action:"STOP",user:i})}return o.typingUsers={},e})())})},u.prototype.snapshot=function(){for(var e=[],t=0,n=this.get();t<n.length;t++){var i=n[t];e.push({action:"START",user:i})}return e},u.prototype.abortRunning=function(){this.taskQueue.abortRunning()},n.default=u},{2:2,35:35,38:38,41:41}],29:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var o=e(35),r=e(2);function s(){}s.extractHeaders=function(e){var n={},e=e.getAllResponseHeaders();return e&&e.trim().split(/[\r\n]+/).forEach(function(e){var e=e.split(": "),t=e.shift(),e=e.join(": ");n[t]=e}),n},s.GET=function(i){return new Promise(function(e,t){var n=new XMLHttpRequest;n.onreadystatechange=function(){n.readyState===XMLHttpRequest.DONE&&(200===n.status||304===n.status?e({responseText:n.responseText,responseHeaders:s.extractHeaders(n)}):t(s.generateError(n.status,n.statusText)))},n.ontimeout=function(){t(s.generateError(408,"client timeout"))},n.open("GET",i,!0),n.timeout=6e4,n.send(),o.default(r.DEBUG_LEVEL,"GET: "+i)})},s.generateError=function(e,t){return{statusCode:e,statusText:t}},n.default=s},{2:2,35:35}],30:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e(35),o=e(2),r=e(1),s=e(18),a=e(3),u=e(41);function l(e,t){var n=this;this.reduceTimeout=void 0,this.fired=!1,this.disconnected=!0,this.onConnectionStatusChange=function(e){"DISCONNECTED"!==e||n.visibilityHandler.isPageVisible()||n.isFired()||2===s.default.state.actual||n.fire(void 0!==n.reduceTimeout)},this.sharedBus=e,this.visibilityHandler=t,this.sharedBus.subscribe(a.SharedEvent.PageHiding,this.reduce.bind(this)),this.sharedBus.subscribe(a.SharedEvent.PageShowing,this.reset.bind(this)),this.sharedBus.subscribe(a.SharedEvent.ConnectionStatus,function(e){n.disconnected="DISCONNECTED"===e})}l.prototype.init=function(e,t){this.onReduce=e,this.onReset=t},l.prototype.isFired=function(){return this.fired},l.prototype.restartListening=function(){this.isFired()&&(this.fired=!1,this.startListening())},l.prototype.startListening=function(){var t=this;i.default(o.DEBUG_LEVEL,"startListening"),this.sharedBus.subscribe(a.SharedEvent.ConnectionStatus,this.onConnectionStatusChange),this.reduceTimeout=window.setTimeout(function(e){t.fire(void 0!==t.reduceTimeout)},r.default.DISCONNECTION_GRACE_PERIOD)},l.prototype.stopListening=function(){i.default(o.DEBUG_LEVEL,"stopListening"),clearTimeout(this.reduceTimeout),this.reduceTimeout=void 0,this.sharedBus.unsubscribe(a.SharedEvent.ConnectionStatus,this.onConnectionStatusChange)},l.prototype.fire=function(e){i.default(o.DEBUG_LEVEL,"fire",e),this.fired=!0,u.isFunction(this.onReduce)&&this.onReduce(),e&&this.stopListening()},l.prototype.reduce=function(){this.fired=!1,this.disconnected?this.onConnectionStatusChange("DISCONNECTED"):this.startListening()},l.prototype.reset=function(){this.isFired()?(this.fired=!1,u.isFunction(this.onReset)&&this.onReset()):this.stopListening()},n.default=l},{1:1,18:18,2:2,3:3,35:35,41:41}],31:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e(35),o=e(2),r=e(1),s=e(3);function a(e,t){var n=this;this.clearSnapshotListener=function(e){"DISCONNECTED"===e?n.set():n.reset()},this.sharedBus=e,this.clearSnapshotFn=t}a.prototype.activate=function(){i.default(o.DEBUG_LEVEL,"activated"),this.sharedBus.subscribe(s.SharedEvent.ConnectionStatus,this.clearSnapshotListener)},a.prototype.deactivate=function(){i.default(o.DEBUG_LEVEL,"deactivated"),this.reset(),this.sharedBus.unsubscribe(s.SharedEvent.ConnectionStatus,this.clearSnapshotListener)},a.prototype.set=function(){this.clearSnapshotTimeout||(this.clearSnapshotTimeout=window.setTimeout(this.clearSnapshotFn,r.default.CHAT_SNAPSHOT_GRACE_PRERIOD))},a.prototype.reset=function(){this.clearSnapshotTimeout&&(clearTimeout(this.clearSnapshotTimeout),this.clearSnapshotTimeout=null)},n.default=a},{1:1,2:2,3:3,35:35}],32:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var c=e(41),d=e(2),E=e(1),i=e(39),u=e(13),l=e(34),o=e(43),r=e(44),h=e(35),f=e(2);function s(){}s.getInstance=function(){return s.instance=s.instance?s.instance:new s},s.prototype.init=function(){var t=this;return this.getVerifiedContext().then(function(e){return t.context=e}).catch(function(e){throw new o.default(r.ApiErrorCode.TECHNICAL_PROBLEM,"Invalid location")})},s.prototype.update=function(e,t){h.default(f.DEBUG_LEVEL,"Update context",e=void 0===e?null:e,t=void 0===t?null:t);var n=this.getReferrerValue();return this.context&&n===this.context.ref?(e&&(this.context.siteCtx=e,this.context.visualizedPage=this.context.siteCtx+this.context.pageCtx,this.context.homePage=this.context.siteCtx+"/"),t&&(this.context.groupSiteCtx=t,this.context.groupHomePage=t+"/")):this.context=this.createContext(n,e,t),this.context},s.prototype.isVisualizedPage=function(e){return this.context.siteCtx+this.context.pageCtx===e},s.prototype.getVerifiedContext=function(){var i=this,o=this.getReferrerValue();return new Promise(function(t,n){o?void 0===E.default.TECHNICAL_CONF.file_name?i.verifyParentOrigin(o).then(function(e){return i.createContext(o)}).then(function(e){/\.googleusercontent\.com$/.test(e.siteCtx)?(h.default(f.ERROR_LEVEL,"Now4real is not compatible with the site: "+e.siteCtx),n("Invalid site")):t(e)}).catch(function(e){n(e)}):t(i.createContext(o)):n("Invalid referrer")})},s.prototype.createContext=function(e,t,n){h.default(f.DEBUG_LEVEL,"Creating context",e,t=void 0===t?null:t,n=void 0===n?null:n);var i=this.getPageContext(e),t=t||this.getSiteContext(e),n=n||null,o=void 0===E.default.TECHNICAL_CONF.file_name?this.getParentOrigin(e,!1):null,r=this.getOurOrigin(),s=!!o&&o.endsWith(d.default.G_TRANSLATE_DOMAIN);return{ref:e,siteCtx:t,pageCtx:i,groupSiteCtx:n,visualizedPage:t+i,homePage:t+"/",groupHomePage:n?n+"/":null,parentOrigin:o,ourOrigin:r,gTranslateRemapped:s}},s.prototype.getReferrerValue=function(){var e=document.customReferrer,e=e||E.default.TECHNICAL_CONF.location;return e},s.prototype.getComputedReferrer=function(e,t){var n,i;return(e=(t=void 0===t?!0:t)&&(e&&(t=c.parseUrl(e))&&(t.hostname.endsWith(d.default.G_TRANSLATE_DOMAIN)?(i=e.match(/[^-]*-[^-]*-(.+)\.translate\.goog(.*)/))&&(e=t.protocol+"//"+i[1].replace(/-/g,".")+(i[2]||"/")):new RegExp("^"+d.default.LOCALHOST+"$|^127(?:.[0-9]{1,3}){3}$").test(t.hostname)&&(i=t.pathname,n=t.search,t=t.hash,/file:\/\//i.test(i)&&(i="/"+i.split("/").pop()),e=d.default.HTTPS+"://"+E.default.SANDBOX_SITE_CONTEXT+i+n+t)),void 0!==(i=E.default.TECHNICAL_CONF.file_name))?d.default.HTTPS+"://"+E.default.SANDBOX_SITE_CONTEXT+"/"+i:e)?(h.default(f.DEBUG_LEVEL,"Computed referrer: "+e),e):(h.default(f.ERROR_LEVEL,"Empty referrer"),null)},s.prototype.getPageContext=function(e){var t,n,i,o,r,s,a,u,e=this.getComputedReferrer(e),l=E.default.CONF.page_context;return null!=l?(u=void 0,u=c.isString(l)?l.startsWith(d.default.SLASH)?l:d.default.SLASH+l:(n=t="",i=l.query,l=l.fragment,o=c.parseUrl(e),i&&o.search&&(r=new URLSearchParams(o.search),c.isBoolean(i)?(r.sort(),t=r.toString()):c.isArray(i)?(s=new URLSearchParams,i.forEach(function(t){var e=r.getAll(t);e.length&&e.forEach(function(e){s.append(t,e)})}),s.sort(),t=s.toString()):c.isRegExp(i)&&(a=new URLSearchParams,r.forEach(function(e,t){i.test(t)&&a.append(t,e)}),a.sort(),t=a.toString()),t=t&&"?"+(t=t.replace(/=$|=(?=&)/g,""))),l&&o.hash&&(n=o.hash),o.pathname+t+n),h.default(f.DEBUG_LEVEL,"Custom Page Context: "+u),u):(l=c.parseUrl(e).pathname,h.default(f.DEBUG_LEVEL,"Retrieved Page Context: "+l),this.normalizePathname(l))},s.prototype.getSiteContext=function(e){e=this.getComputedReferrer(e),e=c.parseUrl(e).host;return h.default(f.DEBUG_LEVEL,"Retrieved Site Context: "+e),e.toLowerCase()},s.prototype.getParentOrigin=function(e,t){e=c.parseUrl(this.getComputedReferrer(e,t)),t=e.origin;return h.default(f.DEBUG_LEVEL,"Retrieved parent origin: "+t,e),t},s.prototype.verifyParentOrigin=function(e){var r=c.parseUrl(e).origin,s=c.generateRandom(16),a=window.parent;return i.timeout(E.default.ORIGIN_VERIFICATION_TIMEOUT,new Promise(function(n,i){function o(e){var t=e.data;e.source===a&&e.origin===r&&"verify"===t.cmd&&(h.default(f.DEBUG_LEVEL,"Origin verification event",e),t.payload.id===s?(l.default.removeEventListener(window,"message",o),n(r)):i("Invalid verification"))}l.default.addEventListener(window,"message",o),a.postMessage(new u.VerifyEvent({id:s}),r),h.default(f.DEBUG_LEVEL,"Started origin verification",e,r,s)}))},s.prototype.getOurOrigin=function(){var e=window.n4rConfig,t=-1<window.location.host.indexOf("localhost"),n="file:"===window.location.protocol,i=-1<window.location.host.indexOf("cdn");return n||e&&t?"http://localhost:3000":i||!e&&t?window.location.origin:"https://cdn.now4real.com"},s.prototype.normalizePathname=function(e){return c.isString(e)?/\/([Hh]ome|[Ii]ndex|[Dd]efault)(\.\w+)?/.test(e)?e.substring(0,e.length-e.split("/").pop().length):e:null},n.default=s},{1:1,13:13,2:2,34:34,35:35,39:39,41:41,43:43,44:44}],33:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.decode=n.isValid=void 0;var i=e(41);function o(e){return e.replace(/-/g,"+").replace(/_/g,"/")}function r(e){return decodeURIComponent(atob(e).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""))}n.isValid=function(e){return!!e&&i.isString(e)&&/^[^\.\s]+\.[^\.\s]+\.[^\.\s]*$/.test(e)},n.decode=function(e){return(e=e.split("."))?{header:JSON.parse(r(o(e[0]))),payload:JSON.parse(r(o(e[1]))),signature:e[2]||null}:null}},{41:41}],34:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var s=e(1),a=e(21),i=e(41),o=e(10),u=e(7),l=e(35),c=e(2),e=(r.prototype.init=function(e,t,n){this.integratorOrigin=t,this.ourOrigin=n,l.default(c.DEBUG_LEVEL,"Origins: our -> "+n+", integrator -> "+t),this.callbacks=e,this.initMessageListener()},r.prototype.reset=function(){l.default(c.DEBUG_LEVEL,"Listeners resetted"),this.removeEventListener(window,"message",this.messageEventHandler)},r.prototype.initMessageListener=function(){if(!o.test(1))throw new Error("Message API not supported!");this.addEventListener(window,"message",this.messageEventHandler)},r.prototype.addEventListener=function(e,t,n){document.addEventListener&&e.addEventListener(t,n,!1)},r.prototype.removeEventListener=function(e,t,n){document.removeEventListener&&e.removeEventListener(t,n,!1)},r.prototype.checkOrigin=function(e,t){return(t=void 0===t?!1:t)?void 0!==s.default.TECHNICAL_CONF.file_name||e===this.integratorOrigin:e===this.ourOrigin},r.prototype.isProxyMessage=function(e){return i.isObject(e)&&"cmd"in e&&"payload"in e&&"PROXY"===e.iss},r.prototype.isEmailRequestMessage=function(e){return i.isObject(e)&&"cmd"in e&&"getStoredEmail"===e.cmd},r);function r(){var r=this;this.messageEventHandler=function(e){var t,n,i=e.data,o=e.origin||e.originalEvent.origin;r.checkOrigin(o,!0)&&r.isProxyMessage(i)?(l.default(c.DEBUG_LEVEL,"Proxy message received"),r.callbacks.onProxyCommand(i.id,i.cmd,i.payload)):r.checkOrigin(o)&&r.isEmailRequestMessage(i)&&(i=i.siteKey,n=void l.default(c.DEBUG_LEVEL,"Get email message received",i),i&&(null==(t=u.default.storagePerSite)?void 0:t.getSiteKey())==="n4rAuth@"+i?n=u.default.storagePerSite.getItem(s.default.EMAIL_AUTH_KEY):i||(n=a.default.getUser()),n)&&n.email&&e.source.postMessage({email:n.email},o)}}n.default=new e},{1:1,10:10,2:2,21:21,35:35,41:41,7:7}],35:[function(e,t,n){var r=this&&this.__spreadArrays||function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;for(var i=Array(e),o=0,t=0;t<n;t++)for(var r=arguments[t],s=0,a=r.length;s<a;s++,o++)i[o]=r[s];return i},s=(Object.defineProperty(n,"__esModule",{value:!0}),e(1)),a=e(3);function u(e,t){return t.length>=e?t:t+new Array(e-t.length+1).join(" ")}var l="[NOW4REAL-"+u(s.default.MODULE_MAX_LENGTH,s.default.MODULE_PREFIX)+"]";n.default=function(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];var o=s.default.LOGGER_LEVEL;window.console&&o!==a.LoggerLevels.Off&&o<=e&&(o=e!==a.LoggerLevels.Error&&e!==a.LoggerLevels.Warn||void 0===console.error?"log":"error",e=u(s.default.LEVEL_MAX_LENGTH,a.LoggerLevels[e]),e=l+" "+e+" | "+t,0!==n.length?console[o].apply(console,r([e],n)):console[o](e))}},{1:1,3:3}],36:[function(i,e,a){!function(n){!function(){Object.defineProperty(a,"__esModule",{value:!0});var E=i(43),h=i(44),f=i(3),p=i(41),o=i(33),u=i(2),S=i(7),T=i(1),g=i(21),r=i(22),L=i(13),C=i(39),t=i(10),_=i(4),s=i(34),l="undefined"!=typeof window?window.LS:void 0!==n?n.LS:null,A=i(35),b=i(2),v=/^CONNECTED:(?!STREAM-SENSING)/;function e(){this.firstConnectionEstablished=!1,this.connecting=!1,this.felsCacherEnabled=!1,this.initialJWT=null}e.getInstance=function(){return e.instance=e.instance?e.instance:new e},e.prototype.init=function(e,t,n,i,o,r,s){var a=this,e=(this.version=e,this.siteJSONConf=t,this.initialContext=n,this.analyticsMode=o,this.JWTMode=r,this.webViewMode=s,this.balancerEndpoint=p.computeFelsEndpoint(T.default.TECHNICAL_CONF.env_subdom),g.default.getControlLink()||this.balancerEndpoint),t=p.parseUrl(this.balancerEndpoint).protocol,n=(this.felsProtocol=t,A.default(b.DEBUG_LEVEL,"felsEndpoint",e,t),new l.LightstreamerClient(e,T.default.FELS_ADAPTER_SET)),o=n.connectionOptions,r=(o.setReverseHeartbeatInterval(3e4),o.setSessionRecoveryTimeout(2e3),o.setRetryDelay(4e3),o.setCookieHandlingRequired(!0),i&&(A.default(b.DEBUG_LEVEL,"DEMO"),n.connectionDetails.setAdapterSet("DEMO")),{onStatusChange:function(e){var t=e.startsWith(u.default.CONNECTED+":")||e===u.default.DISCONNECTED_TRYING_RECOVERY&&"CONNECTED"===a.oldStatus,t=(A.default(b.INFO_LEVEL,e),t?"CONNECTED":"DISCONNECTED");a.oldStatus!==t&&(a.statusListener&&p.isFunction(a.statusListener.onStatusChanged)&&a.statusListener.onStatusChanged(t),a.oldStatus=t),v.test(e)?a.handleFelsSaving():e===u.default.DISCONNECTED_WILL_RETRY&&a.handleFelsSwitch()},onPropertyChange:function(e){var t;"sessionId"===e?(t=a.lsConnectionDetails.getSessionId(),!a.sessionId&&t&&(a.sessionId=t,a.lsConnectionDetails.setUser(a.getUpdatedLsUser())),A.default(b.INFO_LEVEL,e+": "+t)):-1<["user","password"].indexOf(e)&&A.default(b.DEBUG_LEVEL,"Changed "+e+" property")},onServerError:function(e,t){var n,i;if(a.firstConnectionEstablished&&(A.default(b.ERROR_LEVEL,"onServerError event",e,t),a.statusListener))switch(e){case f.N4RServerError.UnsupportedClient:null!=(n=a.statusListener)&&n.onUnsupportedClient();break;case f.N4RServerError.AuthenticationExpired:a.connecting||(a.mode===f.ConnectMode.JWT?S.default.jwtProviderFnPresence?C.timeout(T.default.JWT_RESOLVER_TIMEOUT,S.default.loaderChannel.send(new L.GetUpdatedJWTEvent)).then(function(e){A.default(b.DEBUG_LEVEL,"obtained new JWT 2",e),a.handleJWTUpdate(e)}).catch(function(e){A.default(b.ERROR_LEVEL,e.message),null!=(e=a.statusListener)&&e.onJWTExpired()}):null!=(n=a.statusListener)&&n.onJWTExpired():a.mode!==f.ConnectMode.SOCIAL&&a.mode!==f.ConnectMode.EMAIL||null!=(n=a.statusListener)&&n.onCredentialExpired());break;case f.LSServerError.WrongCredentials:case f.N4RServerError.Unauthorized:a.handleUnauthorizedError(p.parseErrorMsg(e,t).reason);break;case f.N4RServerError.TemporarilyUnavailable:a.connecting||(i=(n=p.parseErrorMsg(e,t)).redirect,n.siteConf?a.handleUnauthorizedError(u.default.SITE_CONFIGURATION_CHANGED):a.handleFelsSwitch(i));break;case f.LSServerError.AllowedSessionCountReached:case f.LSServerError.SessionCountLimitReached:case f.LSServerError.ServerTooBusy:case f.LSServerError.ServerBlocked:a.connecting||a.handleFelsSwitch()}}});return n.addListener(r),this.lsClient=n,this.lsConnectionDetails=n.connectionDetails,n},e.prototype.addStatusListener=function(e){this.statusListener=e},e.prototype.enableFelsCacher=function(){this.felsCacherEnabled=!0,this.handleFelsSaving()},e.prototype.setPerms=function(e){e&&(this.perms=e,this.lsConnectionDetails)&&this.lsConnectionDetails.getUser()&&this.lsConnectionDetails.setUser(this.getUpdatedLsUser())},e.prototype.firstConnection=function(){var i,o=this;return new Promise(function(t,n){o.getFirstConnectionDetails().then(function(t){var e=T.default.TECHNICAL_CONF.no_initial_config,n=o.siteJSONConf.get().conf;if(e&&n){if(o.requiresReload(n))throw new E.default(h.ApiErrorCode.RELOAD_REQUIRED,JSON.stringify(o.siteJSONConf.getRaw()));if(o.requiresConfigUpdate(n))return o.requireConfigUpdate(n).then(function(e){var t;A.default(b.DEBUG_LEVEL,"fixing config",e),null!=(t=o.statusListener)&&t.onConfigChange(e)}).then(function(e){return t})}return t}).then(function(e){var t=e.connectMode,e=e.connectOptions,n=(i=t,o.siteJSONConf.get().auth),n=!o.analyticsMode&&(t===f.ConnectMode.JWT&&1!==n||t!==f.ConnectMode.JWT&&1===n);return A.default(b.DEBUG_LEVEL,"First connection",t,e,n),o.connect(t,e,n)}).then(function(e){o.firstConnectionEstablished=!0,o.firstConnectionSiteAuthentication=o.siteJSONConf.get().auth,t(e)}).catch(function(e){i!==f.ConnectMode.READ_ONLY&&i!==f.ConnectMode.N4R&&o.isAccessDeniedError(e)?o.switchToUnauthenticated().then(function(e){o.firstConnectionEstablished=!0,o.firstConnectionSiteAuthentication=o.siteJSONConf.get().auth,t(o.mode)}).catch(function(e){n(e)}):o.isAuthMismatchError(e)?n(new E.default(h.ApiErrorCode.ACCESS_DENIED,e.message)):n(e)})})},e.prototype.getFirstConnectionDetails=function(){var i=this;return new Promise(function(t,n){i.JWTMode&&S.default.jwtProviderFnPresence?C.timeout(T.default.JWT_RESOLVER_TIMEOUT,S.default.loaderChannel.send(new L.GetUpdatedJWTEvent)).then(function(e){A.default(b.DEBUG_LEVEL,"obtained first JWT",e),i.initialJWT=S.default.latestJWT=e,t(i.computeConnectionDetails(e))}).catch(function(e){A.default(b.ERROR_LEVEL,e.message),n(new E.default(h.ApiErrorCode.ACCESS_DENIED,e.message))}):t(i.computeConnectionDetails())})},e.prototype.switchToAuthenticated=function(i,o){var r=this;return new Promise(function(t,n){A.default(b.DEBUG_LEVEL,"Switching to authenticated",i,o),r.setPerms([]),r.disconnect().then(function(e){r.connect(i,o).then(function(e){t(o)}).catch(function(t){r.isAccessDeniedError(t)?r.connect(f.ConnectMode.READ_ONLY).then(function(e){n(t)}).catch(function(e){n(e),r.isAuthMismatchError(e)&&r.handleUnauthorizedError(u.default.SITE_CONFIGURATION_CHANGED)}):(n(t),r.isAuthMismatchError(t)&&r.handleUnauthorizedError(u.default.SITE_CONFIGURATION_CHANGED))})})})},e.prototype.switchToUnauthenticated=function(){var i=this;return new Promise(function(t,n){A.default(b.DEBUG_LEVEL,"Switching to unauthenticated"),i.setPerms([]),i.disconnect().then(function(e){i.connect(f.ConnectMode.READ_ONLY).then(function(e){t()}).catch(function(e){n(e),i.isAuthMismatchError(e)&&i.handleUnauthorizedError(u.default.SITE_CONFIGURATION_CHANGED)})})})},e.prototype.disconnectClient=function(){this.lsClient.disconnect()},e.prototype.reconnectClient=function(){var e;t.isStorageAvailable()&&(e=g.default.getControlLink(),this.lsConnectionDetails.setServerAddress(e||this.balancerEndpoint)),this.lsClient.connect()},e.prototype.computeConnectionDetails=function(e){var t,n=this.siteJSONConf.get(),i=n.auth,n=n.siteKey,o=3===i;return o=this.analyticsMode?(t=f.ConnectMode.N4R,T.default.TECHNICAL_CONF.n4r_jwt||null):this.JWTMode?(t=f.ConnectMode.JWT,e||T.default.CONF.custom_auth.jwt):2===i?(e=(S.default.storagePerSite=new r.default(u.default.STORAGE_LOGIN_KEY+"@"+n)).getItem(T.default.NO_RE_AUTH_KEY),t=f.ConnectMode.NO_REGISTRATION,e?e.token:null):o?(i=(S.default.storagePerSite=new r.default(u.default.STORAGE_LOGIN_KEY+"@"+n)).getItem(T.default.EMAIL_AUTH_KEY),t=f.ConnectMode.EMAIL,i||null):(t=(e=g.default.getUser())&&!this.webViewMode?f.ConnectMode.SOCIAL:f.ConnectMode.READ_ONLY,e&&!this.webViewMode?e:null),{connectMode:t,connectOptions:o}},e.prototype.isAccessDeniedError=function(e){return e.code===h.ApiErrorCode.ACCESS_DENIED},e.prototype.isAuthMismatchError=function(e){return e.code===h.ApiErrorCode.MISMATCH},e.prototype.computeLSUser=function(e,t,n){void 0===n&&(n=!1);e=e||"",t=t||{};return Object.keys(t).length||(t.site=this.initialContext,t["x-conf"]=T.default.CONF),n||(t.sitev=this.siteJSONConf.get().version),this.sessionId&&(t.sid=p.uncapitalizeString(this.sessionId)),this.perms&&(t.perms=this.perms),[this.version,e,JSON.stringify(t,function(e,t){return!0===t?1:!1===t?0:null!==t?t:void 0})].join(u.default.TAB)},e.prototype.computeLSCredentials=function(e,t,n){var i;if(void 0===n&&(n=!1),e===f.ConnectMode.JWT||e===f.ConnectMode.N4R){var o=null,r=null;if(t){var s=p.splitIncludeSeparator(t,".");if(!s||5!==s.length)throw new E.default(h.ApiErrorCode.ACCESS_DENIED,"Invalid JWT");r=s.pop(),o=s.join("")}s=this.computeLSUser(o,null,n),o=r}else o=e===f.ConnectMode.NO_REGISTRATION?(s=this.computeLSUser(t,null,n),null):e===f.ConnectMode.EMAIL?(s=this.computeLSUser((i=t)?i.id:null,null,n),i?i.secret:null):e===f.ConnectMode.SOCIAL?(s=this.computeLSUser((i=t).id,null,n),i.secret):(s=this.computeLSUser(null,null,n),null);return[s,o]},e.prototype.getUpdatedLsUser=function(){var e=this.lsConnectionDetails.getUser().split(u.default.TAB),t=e[1],e=JSON.parse(e[2]);return this.computeLSUser(t,e)},e.prototype.updateJWT=function(e){if(!this.initialJWT||!o.isValid(e))throw new Error("Invalid JWT or missing initial");var t=this.initialJWT,t=o.decode(t).payload,n=o.decode(e).payload,i=t.sub;if(i!==n.sub)throw new Error("'sub' claim changed. It should have been equal to: "+i);i=t.iss;if(i!==n.iss)throw new Error("'iss' claim changed. It should have been equal to: "+i);t=this.lsConnectionDetails.getUser().split(u.default.TAB),n=JSON.parse(t[2]),i=p.splitIncludeSeparator(e,"."),t=i.pop(),i=i.join("");this.lsConnectionDetails.setUser(this.computeLSUser(i,n)),this.lsConnectionDetails.setPassword(t),S.default.latestJWT=e},e.prototype.handleJWTUpdate=function(e){this.updateJWT(e),null!=(e=S.default.bandwidthReducer)&&e.isFired()||this.lsClient.connect()},e.prototype.handleFelsSaving=function(){var e;this.felsCacherEnabled&&(e=this.lsConnectionDetails.getServerInstanceAddress(),A.default(b.DEBUG_LEVEL,"handleFelsSaving",e),e)&&e!==this.balancerEndpoint&&(A.default(b.DEBUG_LEVEL,"control link detected",e),T.default.LOCAL_PERSISTENCE&&g.default.addOrUpdateControlLink(e),this.lsConnectionDetails.setServerAddress(e))},e.prototype.handleFelsSwitch=function(e){var t=this.lsConnectionDetails.getServerAddress(),n=this.lsClient.getStatus(),i=S.default.bandwidthReducer.isFired(),n=(A.default(b.DEBUG_LEVEL,"handleFelsSwitch",e,t,n,i,this.balancerEndpoint),n===u.default.DISCONNECTED);if(e||t!==this.balancerEndpoint){A.default(b.DEBUG_LEVEL,"switching"),g.default.deleteControlLink(),this.lsClient.disconnect();try{this.lsConnectionDetails.setServerAddress(e?this.felsProtocol+"//"+e+"/":this.balancerEndpoint)}catch(e){A.default(b.ERROR_LEVEL,e.message),this.lsConnectionDetails.setServerAddress(this.balancerEndpoint)}n=!0}n&&!i&&(A.default(b.DEBUG_LEVEL,"reconnecting"),this.lsClient.connect())},e.prototype.handleConfUpdate=function(e){A.default(b.DEBUG_LEVEL,"handleConfUpdate",e),this.siteJSONConf.update(JSON.stringify(e));var e=this.computeConnectionDetails(S.default.latestJWT),t=e.connectMode,e=this.computeLSCredentials(t,e.connectOptions),n=e[0],e=e[1];return this.lsConnectionDetails.setUser(n),this.lsConnectionDetails.setPassword(e),this.lsClient.connect(),t},e.prototype.connect=function(l,r,s){var a,c=this,d=(void 0===s&&(s=!1),this.connecting=!0,l);return new Promise(function(t,n){function u(e){c.connecting=!1,c.lsClient.removeListener(a),n(e)}a={onStatusChange:function(e){v.test(e)&&(c.mode=d,e=d,c.connecting=!1,c.lsClient.removeListener(a),t(e))},onServerError:function(e,t){A.default(b.ERROR_LEVEL,t,e);var n=p.parseErrorMsg(e,t);switch(e){case f.LSServerError.WrongCredentials:d===f.ConnectMode.SOCIAL?g.default.deleteUser():d===f.ConnectMode.EMAIL&&(null!=(a=S.default.storagePerSite)&&a.removeItem(T.default.EMAIL_AUTH_KEY),null!=a)&&a.removeItem(T.default.EMAIL_AUTH_MASTER_KEY),u(new E.default(h.ApiErrorCode.ACCESS_DENIED,n));break;case f.N4RServerError.Unauthorized:u(new E.default(h.ApiErrorCode.ACCESS_DENIED,n));break;case f.N4RServerError.AuthenticationExpired:l===f.ConnectMode.JWT&&S.default.jwtProviderFnPresence?C.timeout(T.default.JWT_RESOLVER_TIMEOUT,S.default.loaderChannel.send(new L.GetUpdatedJWTEvent)).then(function(e){A.default(b.DEBUG_LEVEL,"obtained new JWT 1",e),c.handleJWTUpdate(e)}).catch(function(e){A.default(b.ERROR_LEVEL,e.message),u(new E.default(h.ApiErrorCode.ACCESS_DENIED,n))}):u(new E.default(h.ApiErrorCode.ACCESS_DENIED,n));break;case f.N4RServerError.UnsupportedClient:u(new E.default(h.ApiErrorCode.TECHNICAL_PROBLEM,"Unsupported client"));break;case f.N4RServerError.UnsupportedBrowser:u(new E.default(h.ApiErrorCode.TECHNICAL_PROBLEM,"Unsupported browser"));break;case f.N4RServerError.TemporarilyUnavailable:var i,o,r,s=n.siteConf,a=n.redirect;s?(i=s.s,o=s.a,r=s.c||{},i?!o&&(!c.firstConnectionEstablished&&l===f.ConnectMode.JWT||c.firstConnectionEstablished&&o!==c.firstConnectionSiteAuthentication&&l!==f.ConnectMode.N4R)?u(new E.default(h.ApiErrorCode.MISMATCH,"This site requires social authentication")):1===o&&l!==f.ConnectMode.JWT&&l!==f.ConnectMode.N4R?u(new E.default(h.ApiErrorCode.MISMATCH,"This site requires JWT authentication")):2===o&&(!c.firstConnectionEstablished&&l===f.ConnectMode.JWT||c.firstConnectionEstablished&&o!==c.firstConnectionSiteAuthentication&&l!==f.ConnectMode.N4R)?u(new E.default(h.ApiErrorCode.MISMATCH,"This site requires No Registration login")):3===o&&(!c.firstConnectionEstablished&&l===f.ConnectMode.JWT||c.firstConnectionEstablished&&o!==c.firstConnectionSiteAuthentication&&l!==f.ConnectMode.N4R)?u(new E.default(h.ApiErrorCode.MISMATCH,"This site requires Email login")):!c.firstConnectionEstablished&&c.requiresReload(r)?u(new E.default(h.ApiErrorCode.RELOAD_REQUIRED,JSON.stringify(s))):!c.firstConnectionEstablished&&c.requiresConfigUpdate(r)?c.requireConfigUpdate(r).then(function(e){var t;A.default(b.DEBUG_LEVEL,"obtained new config",e),null!=(t=c.statusListener)&&t.onConfigChange(e),d=c.handleConfUpdate(s)}).catch(function(e){A.default(b.DEBUG_LEVEL,e),u(new E.default(h.ApiErrorCode.TECHNICAL_PROBLEM,"unable to refresh config"))}):d=c.handleConfUpdate(s):u(_.creditExhaustedError)):c.handleFelsSwitch(a);break;case f.LSServerError.AllowedSessionCountReached:case f.LSServerError.SessionCountLimitReached:case f.LSServerError.ServerTooBusy:case f.LSServerError.ServerBlocked:c.handleFelsSwitch();break;default:u(new E.default(h.ApiErrorCode.TECHNICAL_PROBLEM,n))}}},c.lsClient.addListener(a);try{var e=c.computeLSCredentials(l,r,s),i=e[0],o=e[1];c.lsConnectionDetails.setUser(i),c.lsConnectionDetails.setPassword(o),A.default(b.DEBUG_LEVEL,l+" attempt",r,i,o),s=!1,c.lsClient.connect()}catch(e){u(e)}})},e.prototype.disconnect=function(){var i=this;return new Promise(function(t){var n;i.lsClient.getStatus()===u.default.DISCONNECTED?t():(n={onStatusChange:function(e){e===u.default.DISCONNECTED&&(i.lsClient.removeListener(n),t())}},i.lsClient.addListener(n),i.lsClient.disconnect())})},e.prototype.handleUnauthorizedError=function(e){var t;switch(e){case u.default.SITE_CONFIGURATION_CHANGED:null!=(t=this.statusListener)&&t.onConfigChanged();break;case u.default.SITE_NOT_ACTIVE:null!=(t=this.statusListener)&&t.onCreditExhausted();break;default:this.mode===f.ConnectMode.JWT&&null!=(t=this.statusListener)&&t.onJWTExpired()}},e.prototype.requiresReload=function(e){var t,n,i,o,r,s,a,u,l,c,d,E,h,f,p,S,g,L,C,_;try{return A.default(b.DEBUG_LEVEL,"requiresReload",e),this.analyticsMode||top===self?!1:(a=T.default.SCRIPT_CONF,u=T.default.CONF,l=a.target,c=u.target,d=null!=(t=e.target)?t:"widget",E=a.page_context,h=u.page_context,f=null!=(n=e.page_context)?n:null,p=a.param_overriding,S=u.param_overriding,g=null!=(i=e.param_overriding)&&i,L=null==(o=a.widget)?void 0:o.container,C=u.widget.container,_=null!=(s=null==(r=e.widget)?void 0:r.container)?s:null,void 0===l&&d!==c||void 0===E&&f!==h||void 0===p&&g!==S||void 0===L&&_!==C)}catch(e){return A.default(b.ERROR_LEVEL,"requiresReload error",e),!1}},e.prototype.requiresConfigUpdate=function(e){try{return A.default(b.DEBUG_LEVEL,"requiresConfigUpdate",e),!this.analyticsMode&&top!==self}catch(e){return A.default(b.ERROR_LEVEL,"requiresConfigUpdate error",e),!1}},e.prototype.requireConfigUpdate=function(e){var r=window.parent;return C.timeout(T.default.ORIGIN_VERIFICATION_TIMEOUT,new Promise(function(n,i){function o(e){var t=e.data;if(e.source===r&&"updateConfig"===t.cmd){A.default(b.DEBUG_LEVEL,"Config update event",e),s.default.removeEventListener(window,"message",o);try{n(t.ih)}catch(e){i("Invalid config update")}}}s.default.addEventListener(window,"message",o),S.default.loaderChannel.send(new L.UpdateConfigEvent(e))}))},a.default=e}.call(this)}.call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{1:1,10:10,13:13,2:2,21:21,22:22,3:3,33:33,34:34,35:35,39:39,4:4,41:41,43:43,44:44,7:7}],37:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var s=e(3),o=e(41),a=e(39),u=e(2),l=e(1),c=e(43),d=e(44),E=e(35),h=e(2);function i(){}i.getInstance=function(){return i.instance=i.instance?i.instance:new i},i.prototype.init=function(e,t){this.lsClient=e,this.getContext=t},i.prototype.invokeGetAuthInfo=function(){return this.invoke(s.RemoteFunctions.GET_AUTH_INFO,{})},i.prototype.invokeLogout=function(e){return this.invoke(s.RemoteFunctions.DELETE_PASSWORD,{password:e})},i.prototype.invokePostMessage=function(e,t){e={payload:e},t=t&&t.replyTo;return t&&(e.reply=t),this.invoke(s.RemoteFunctions.MESSAGE_SEND,e)},i.prototype.invokeDeleteMessage=function(e){return this.invoke(s.RemoteFunctions.MESSAGE_DELETE,{id:e})},i.prototype.invokeFlushChat=function(){return this.invoke(s.RemoteFunctions.CHAT_FLUSH,{})},i.prototype.invokeChatEnable=function(e){return this.invoke(s.RemoteFunctions.CHAT_ENABLE,{enable:e})},i.prototype.invokeMuteUserGet=function(e){return this.invoke(s.RemoteFunctions.MUTE_USER_GET,{userId:e})},i.prototype.invokeMuteUserSet=function(e,t){return this.invoke(s.RemoteFunctions.MUTE_USER_SET,{userId:e,duration:t})},i.prototype.invokeReportChatMessage=function(e,t,n){e={id:e,reason:t};return n&&(e.comment=n),this.invoke(s.RemoteFunctions.REPORT_CHAT_MESSAGE,e)},i.prototype.invokeUserPreferenceSet=function(e){return this.invoke(s.RemoteFunctions.USER_PREFERENCE_SET,{value:e})},i.prototype.invokeLog=function(e){return this.invoke(s.RemoteFunctions.LOG,{msg:e})},i.prototype.invokeUserConsentSet=function(){return this.invoke(s.RemoteFunctions.USER_CONSENT_SET,{})},i.prototype.invokeJWTRefresh=function(e){return this.invoke(s.RemoteFunctions.JWT_REFRESH,{jwt:e},{fireAndForget:!0})},i.prototype.invokePollNew=function(e,t,n){return this.invoke(s.RemoteFunctions.POLL_NEW,{question:e,options:t,maxVotes:n})},i.prototype.invokePollClose=function(e){return this.invoke(s.RemoteFunctions.POLL_CLOSE,{remove:e})},i.prototype.invokePollVoteGet=function(){return this.invoke(s.RemoteFunctions.POLL_VOTE_GET,{})},i.prototype.invokePollVoteSet=function(e){return this.invoke(s.RemoteFunctions.POLL_VOTE_SET,{vote:e})},i.prototype.invoke=function(e,t,n){var i=this.getContext(),i=l.default.CONF.scope===u.default.SITE&&-1<[s.RemoteFunctions.MESSAGE_SEND,s.RemoteFunctions.MESSAGE_DELETE,s.RemoteFunctions.CHAT_FLUSH,s.RemoteFunctions.CHAT_ENABLE,s.RemoteFunctions.MUTE_USER_GET,s.RemoteFunctions.MUTE_USER_SET,s.RemoteFunctions.REPORT_CHAT_MESSAGE,s.RemoteFunctions.USER_CONSENT_SET,s.RemoteFunctions.POLL_NEW,s.RemoteFunctions.POLL_CLOSE,s.RemoteFunctions.POLL_VOTE_GET,s.RemoteFunctions.POLL_VOTE_SET].indexOf(e)?u.default.GROUP_PLACEHOLDER+"/":""+u.default.MASTER_PLACEHOLDER+i.pageCtx,o=this.buildCommand(i,s.RemoteFunctions[e],t),r=(E.default(h.DEBUG_LEVEL,"RPC ("+s.RemoteFunctions[e]+")",o,n),(null!=n&&n.fireAndForget?this.sendCommandAndForget:this.sendCommand).bind(this));return null!=n&&n.retryOnAbort?a.retry(function(){return r(o)},{errKey:"message",errCodes:["onAbort"],retries:5,delay:500}):r(o)},i.prototype.buildCommand=function(e,t,n){return e+u.default.TAB+t+u.default.TAB+JSON.stringify(n)},i.prototype.sendCommand=function(e){var o=this;return new Promise(function(n,i){o.lsClient.sendMessage(e,"s",null,{onDeny:function(e,t,n){E.default(h.DEBUG_LEVEL,"onDeny listener call",e,t,n),o.handleCommandError(t,n,i)},onProcessed:function(e,t){E.default(h.DEBUG_LEVEL,"onProcessed listener call",e,t),o.handleCommandResponse(e,t,n,i)},onDiscarded:function(e){E.default(h.WARN_LEVEL,"onDiscarded listener call",e),i(new c.default(d.ApiErrorCode.TECHNICAL_PROBLEM,"onDiscarded"))},onError:function(e){E.default(h.ERROR_LEVEL,"onError listener call",e),i(new c.default(d.ApiErrorCode.TECHNICAL_PROBLEM,"onError"))},onAbort:function(e,t){E.default(h.DEBUG_LEVEL,"onAbort listener call",e,t),i(new c.default(d.ApiErrorCode.TECHNICAL_PROBLEM,"onAbort"))}},!0)})},i.prototype.sendCommandAndForget=function(n){var i=this;return new Promise(function(e,t){try{i.lsClient.sendMessage(n,"UNORDERED_MESSAGES",null,null,!1),e()}catch(e){t(new c.default(d.ApiErrorCode.TECHNICAL_PROBLEM,e.message))}})},i.prototype.handleCommandError=function(e,t,n){try{switch(e){case s.N4RServerError.TemporarilyUnavailable:n(new c.default(d.ApiErrorCode.SERVICE_UNAVAILABLE,"the service is temporarily unavailable"));break;case s.N4RServerError.Unauthorized:var i=o.parseErrorMsg(e,t);n(new c.default(d.ApiErrorCode.NOT_AUTHORIZED,i));break;default:n(new c.default(d.ApiErrorCode.TECHNICAL_PROBLEM,e.toString()))}}catch(e){E.default(h.ERROR_LEVEL,e),n(new c.default(d.ApiErrorCode.TECHNICAL_PROBLEM,"protocol mismatch"))}},i.prototype.handleCommandResponse=function(e,t,n,i){try{var o,r,s,a=t?JSON.parse(t):null;this.isChatMessage(e)?(o=a.publish,r=a.moderation,s=a.error,o?n(a):i(s||r)):(this.isReportMsgResponse(e)||this.isUserPreferenceSet(e)||this.isPollRelatedMsg(e))&&(s=a.error)?i(s):n(a)}catch(e){E.default(h.ERROR_LEVEL,e),i(new c.default(d.ApiErrorCode.TECHNICAL_PROBLEM,"protocol mismatch"))}},i.prototype.extractFunctionName=function(e){return e.split(u.default.TAB)[1]},i.prototype.isChatMessage=function(e){return this.extractFunctionName(e)===s.RemoteFunctions[s.RemoteFunctions.MESSAGE_SEND]},i.prototype.isReportMsgResponse=function(e){return this.extractFunctionName(e)===s.RemoteFunctions[s.RemoteFunctions.REPORT_CHAT_MESSAGE]},i.prototype.isUserPreferenceSet=function(e){return this.extractFunctionName(e)===s.RemoteFunctions[s.RemoteFunctions.USER_PREFERENCE_SET]},i.prototype.isPollRelatedMsg=function(e){return[s.RemoteFunctions[s.RemoteFunctions.POLL_NEW],s.RemoteFunctions[s.RemoteFunctions.POLL_CLOSE],s.RemoteFunctions[s.RemoteFunctions.POLL_VOTE_GET],s.RemoteFunctions[s.RemoteFunctions.POLL_VOTE_SET]].includes(this.extractFunctionName(e))},n.default=i},{1:1,2:2,3:3,35:35,39:39,41:41,43:43,44:44}],38:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e(40),o=e(35),r=e(2),u="ABORT_RUNNING";function s(e,t,n){void 0===e&&(e=!1),void 0===t&&(t=1),this.queue=[],this.pendingCount=0,this.concurrency=t,(this.abortable=e)&&(this.pubSub=new i.default(n)),this.name=n||"",this.resolveEmpty=function(){}}s.prototype.next=function(){this.pendingCount--,0<this.queue.length?this.queue.shift()():this.resolveEmpty()},s.prototype.add=function(s){var a=this;return new Promise(function(o,r){function e(){a.pendingCount++;var t,n,i=!1;a.abortable&&(t=Date.now(),n=function(e){t<e&&(i=!0,r(new Error("Task aborted")),a.pubSub.unsubscribe(u,n),a.next())},a.pubSub.subscribe(u,n)),s().then(function(e){i||(o(e),a.abortable&&a.pubSub.unsubscribe(u,n),a.next())},function(e){i||(r(e),a.abortable&&a.pubSub.unsubscribe(u,n),a.next())})}a.pendingCount<a.concurrency?e():a.queue.push(e)})},s.prototype.abortRunning=function(){this.abortable&&(o.default(r.DEBUG_LEVEL,"abortRunning",this.pubSub.getSubscribersCount(u),this.name),this.pubSub.publish(u,Date.now()))},s.prototype.getPendingCount=function(){return this.pendingCount},n.default=s},{2:2,35:35,40:40}],39:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.timeout=n.retry=n.pause=void 0;var c=e(35),d=e(2);function E(t){return new Promise(function(e){return setTimeout(e,t)})}n.pause=E,n.retry=function i(o,r){var s=r.errKey||"code",a=r.errCodes||"*",u=r.retries||3,l=r.delay||1e3;return o().catch(function(e){var t,n=e[s];return 1<u&&n&&(-1<a.indexOf(n)||"*"===a)?(c.default(d.DEBUG_LEVEL,"Retry "+o+", remaining attempts: "+(t=u-1)+", code: "+n),r.retries=t,E(l).then(function(){return i(o,r)})):Promise.reject(e)})},n.timeout=function(n,e){var i,t=new Promise(function(e,t){i=setTimeout(function(){t(new Error("Timeout after "+n+" ms"))},n)});return Promise.race([e,t]).then(function(e){return clearTimeout(i),e})}},{2:2,35:35}],40:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i={}.hasOwnProperty,r=e(35),s=e(2);function o(e){this.topics={},this.name=e||""}o.prototype.subscribe=function(e,t){var n;r.default(s.DEBUG_LEVEL,"PubSub subscribe",e,this.name,null==(n=this.topics[e])?void 0:n.length),i.call(this.topics,e)||(this.topics[e]=[]),this.topics[e].push(t)},o.prototype.unsubscribe=function(e,t){var n,i=null==(n=this.topics[e])?void 0:n.length;if(i){r.default(s.DEBUG_LEVEL,"PubSub unsubscribe",e,this.name,i);for(var o=0;o<i;o++)if(this.topics[e][o]===t){this.topics[e].splice(o,1),1===i&&delete this.topics[e];break}}},o.prototype.unsubscribeAll=function(e){delete this.topics[e]},o.prototype.publish=function(e,t){i.call(this.topics,e)&&this.topics[e].forEach(function(e){e(void 0!==t?t:{})})},o.prototype.getSubscribersCount=function(e){return this.topics[e]?this.topics[e].length:null},n.default=o},{2:2,35:35}],41:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.parseTimestamp=n.decodeHeatmap=n.decodePercentage=n.getMessageMaxLength=n.authDetailsParser=n.messageDurationParser=n.splitIncludeSeparator=n.getTime=n.generateRandom=n.parseErrorMsg=n.remap=n.deepEqual=n.cloneObject=n.isRegExp=n.isString=n.isNumber=n.isArray=n.isBoolean=n.isFunction=n.isObject=n.createCurrentUser=n.createUser=n.enqueueMicrotask=n.uncapitalizeString=n.countStringSymbols=n.popupBlockerChecker=n.computeFelsEndpoint=n.computeApiGatewayOrigin=n.computeUserAppURL=n.computeCdnOrigin=n.extractFragment=n.parseUrl=n.trimPortFromHost=n.hostContainsDefaultPort=void 0;var o=e(35),r=e(2),s=e(1),a=e(2);function u(e,t){return t?t===a.default.HTTP&&e.endsWith(":80")||"https"===t&&e.endsWith(":443"):(o.default(r.ERROR_LEVEL,"Undefined protocol"),!1)}function l(e){return e.replace(/\:[0-9]{1,4}(.*)/,"$1")}function c(e){return("0"+e.toString(16)).substr(-2)}n.hostContainsDefaultPort=u,n.trimPortFromHost=l,n.parseUrl=function(e){var t,n,i,o,r,s,a;if(e)return(t=document.createElement("a")).href=e,e=t.port,i=t.hostname,o=t.pathname,r=t.search,s=t.hash,a=t.origin,u(n=t.host,(t=t.protocol).slice(0,-1))&&(n=l(n)),{protocol:t,host:n,hostname:i,port:e,pathname:o=o.startsWith("/")?o:"/"+o,origin:a=a||t+"//"+n,search:r,hash:s};throw new Error("Empty URL")},n.extractFragment=function(){return decodeURIComponent(location.hash.substring(1))},n.computeCdnOrigin=function(e){var t=["cdn.",""!==e?e+".":e,"now4real.com"].join("");return o.default(r.DEBUG_LEVEL,"Computed cdn hostname for "+e+" env: "+t),a.default.HTTPS+"://"+t},n.computeUserAppURL=function(e){return this.computeCdnOrigin(e)+"/user-app/"},n.computeApiGatewayOrigin=function(e){var t=["api.",""!==e?e+".":e,"now4real.com"].join("");return o.default(r.DEBUG_LEVEL,"Computed api gateway hostname for "+e+" env: "+t),a.default.HTTPS+"://"+t+":443"},n.computeFelsEndpoint=function(e){if(void 0===e)throw new Error("env err: "+e);"staging"===e||""===e?(i=s.default.FELS_PROTOCOL,n=["fels.",""!==e?e+".":e,"now4real.com"].join(""),t=s.default.FELS_PORT):"devops"===e?(i="http",n="fels.localtest.me",t="4000"):"ci-devops"===e&&(i=a.default.HTTP,n="n4r-fels.now4real-client-integration-test.svc.cluster.local",t="80");var t,n,i=i+"://"+n+":"+t+"/";return o.default(r.DEBUG_LEVEL,"Computed fels for "+e+" env: "+i),i},n.popupBlockerChecker=function(e){return null==e||void 0===e.closed},n.countStringSymbols=function(e){return e.replace(/[\uD800-\uDBFF][\uDC00-\uDFFF]/g,"_").length},n.uncapitalizeString=function(e){return e.charAt(0).toLowerCase()+e.slice(1)},n.enqueueMicrotask=function(e){Promise.resolve().then(function(){e()})},n.createUser=function(e,t,n){return e={id:e.id,name:e.nick,pic:e.icon,provider:e.provider},t&&(e.role=t),n&&(e.badge=n),e},n.createCurrentUser=function(e,t,n,i,o){return(e=this.createUser(e,n,i)).consentGiven=t,o&&(e.preferences=o),e},n.isObject=function(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)},n.isFunction=function(e){return"function"==typeof e},n.isBoolean=function(e){return"boolean"==typeof e},n.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},n.isNumber=function(e){return"number"==typeof e||"object"==typeof e&&e.constructor===Number},n.isString=function(e){return"string"==typeof e},n.isRegExp=function(e){return e instanceof RegExp},n.cloneObject=function(e){return JSON.parse(JSON.stringify(e))},n.deepEqual=function(e,t){return JSON.stringify(e)===JSON.stringify(t)},n.remap=function(e,t){return e.bind(t)},n.parseErrorMsg=function(e,t){return 0<e?t:JSON.parse(t)},n.generateRandom=function(e){var t;if(void 0===e&&(e=8),window.crypto&&window.crypto.getRandomValues&&Uint8Array)return t=new Uint8Array((e||40)/2),window.crypto.getRandomValues(t),Array.prototype.slice.call(t).map(c).join("");for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i="",o=0;o<e;o++)i+=n.charAt(Math.floor(Math.random()*n.length));return i},n.getTime=function(){return(new Date).getTime()},n.splitIncludeSeparator=function(e,t){for(var n=e.split(t),i=n.length;1<i--;)n.splice(i,0,t);return n},n.messageDurationParser=function(e){if(!e||!/^\d+(W|D|h|m)$/.test(e))throw new Error("Invalid duration");var t;switch((e=e.split("")).pop()){case"W":t="WEEKS";break;case"D":t="DAYS";break;case"h":t="HOURS";break;case"m":t="MINUTES"}return{value:Number(e.join("")),unit:t}},n.authDetailsParser=function(e,t,n,i){var o=null;switch(e){case"M":o=a.default.MODERATOR;break;case"G":o=a.default.GUEST}return{role:o,badge:null!==t&&n&&i?{label:t,textColor:"#"+n,backgroundColor:"#"+i}:null}},n.getMessageMaxLength=function(e,t){var e=e.snapshot,n=null;return t?t===a.default.MODERATOR?n=e.messageMaxLengthModerator:t===a.default.GUEST&&(n=e.messageMaxLengthGuest):n=e.messageMaxLength,null!==n?n:s.default.MSG_MAX_LENGTH_DEFAULT},n.decodePercentage=function(e){return e=atob(e),Array.from(e).map(function(e){return e.charCodeAt(0)})},n.decodeHeatmap=function(e,t){var n,e=null==e?void 0:e.match(/.{2}/g),i=null==t?void 0:t.split(""),o={};return e&&i&&(n=0,e.forEach(function(e,t){t=i[t].charCodeAt(0)-32;n+=o[e]=t=0===t?.5:t}),Object.keys(o).forEach(function(e){o[e]=o[e]/n})),o},n.parseTimestamp=function(e){return e?parseInt(e,16):null}},{1:1,2:2,35:35}],42:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0});var i=e(10),o=e(1),r=e(35),s=e(2);function a(e){var t=this;if(this.props=null,this.onPageHiding=null,this.onPageShowing=null,this.onPageTerminated=null,this.visible=null,this.previousVisible=null,this.throttleTimeout=null,this.visibilityChangeHandler=function(){r.default(s.DEBUG_LEVEL,"visibilityChangeHandler"),t.visible=t.isPageVisible(),t.visible||localStorage.setItem("visibilityChangeHandler","Visibility changed: "+document.hidden+", "+new Date),t.throttleTimeout||t.handleNotification()},this.pagehideHandler=function(e){r.default(s.DEBUG_LEVEL,"pagehideHandler"),e.persisted||(null!=(e=t.onPageTerminated)&&e.call(t),localStorage.setItem("pagehideHandler",""+new Date))},!i.test(2))throw new Error("Visibility API not supported!");e.onPageHiding&&(this.onPageHiding=e.onPageHiding),e.onPageShowing&&(this.onPageShowing=e.onPageShowing),e.onPageTerminated&&(this.onPageTerminated=e.onPageTerminated),this.props=i.retrieveVisibilityProperties(),this.visible=this.previousVisible=this.isPageVisible(),document.addEventListener(this.props.visibilityChange,this.visibilityChangeHandler),window.addEventListener("pagehide",this.pagehideHandler)}a.prototype.handleNotification=function(){var t=this,e=this.notifyIfChanged(this.visible);this.throttleTimeout=e?setTimeout(function(e){t.handleNotification()},o.default.VISIBILITY_THROTTLING_PERIOD):null},a.prototype.notifyIfChanged=function(e){var t;return e!==this.previousVisible&&(r.default(s.DEBUG_LEVEL,"notify",e,this.previousVisible,this.throttleTimeout),e?null!=(t=this.onPageShowing)&&t.call(this):null!=(t=this.onPageHiding)&&t.call(this),this.previousVisible=e,!0)},a.prototype.reset=function(){document.removeEventListener(this.props.visibilityChange,this.visibilityChangeHandler),window.removeEventListener("pagehide",this.pagehideHandler)},a.prototype.isPageVisible=function(){return!document[this.props.hidden]},n.default=a},{1:1,10:10,2:2,35:35}],43:[function(e,t,n){function i(e,t){this.code=e,this.message=t}Object.defineProperty(n,"__esModule",{value:!0}),i.prototype.toString=function(){return this.code+" - "+this.message},n.default=i},{}],44:[function(e,t,n){var i;Object.defineProperty(n,"__esModule",{value:!0}),n.SubscriptionSubject=n.ApiErrorCode=void 0,(i=n.ApiErrorCode||(n.ApiErrorCode={})).ABORTED="ABORTED",i.ACCESS_DENIED="ACCESS_DENIED",i.ALREADY_PRESENT="ALREADY_PRESENT",i.ALREADY_REPORTED="ALREADY_REPORTED",i.ALREADY_STARTED="ALREADY_STARTED",i.BLOCKED="BLOCKED",i.CANNOT_MODERATE="CANNOT_MODERATE",i.CHAT_DISABLED="CHAT_DISABLED",i.CLOSED="CLOSED",i.CREDIT_EXHAUSTED="CREDIT_EXHAUSTED",i.CURRENTLY_DISABLED="CURRENTLY_DISABLED",i.DISCONNECTED="DISCONNECTED",i.INVALID_ARGUMENTS="INVALID_ARGUMENTS",i.INVALID_CALL="INVALID_CALL",i.MISMATCH="MISMATCH",i.NOT_AUTHENTICATED="NOT_AUTHENTICATED",i.NOT_AUTHORIZED="NOT_AUTHORIZED",i.NOT_FOUND="NOT_FOUND",i.QUOTA_EXCEEDED="QUOTA_EXCEEDED",i.RELOAD_REQUIRED="RELOAD_REQUIRED",i.SERVICE_UNAVAILABLE="SERVICE_UNAVAILABLE",i.TECHNICAL_PROBLEM="TECHNICAL_PROBLEM",i.TOO_FREQUENT="TOO_FREQUENT",i.USER_MUTED="USER_MUTED",i.CHATBOT="CHATBOT",(i=n.SubscriptionSubject||(n.SubscriptionSubject={})).AUTHORIZATION="AUTHORIZATION",i.CONNECTION_STATUS="CONNECTION_STATUS",i.COUNTER_CHAT_MESSAGES="COUNTER_CHAT_MESSAGES",i.COUNTER_CHAT_TYPING="COUNTER_CHAT_TYPING",i.COUNTER_PAGE_CHATTERS="COUNTER_PAGE_CHATTERS",i.COUNTER_PAGE_VIEWERS="COUNTER_PAGE_VIEWERS",i.COUNTER_SITE_CHATTERS="COUNTER_SITE_CHATTERS",i.COUNTER_SITE_VIEWERS="COUNTER_SITE_VIEWERS",i.HEATMAP_PAGE_VIEWERS="HEATMAP_PAGE_VIEWERS",i.HEATMAP_SITE_VIEWERS="HEATMAP_SITE_VIEWERS",i.LIST_CHAT_MESSAGES="LIST_CHAT_MESSAGES",i.LIST_CHAT_TYPING="LIST_CHAT_TYPING",i.LOGIN_STATUS="LOGIN_STATUS",i.PARAMETERS="PARAMETERS",i.POLL="POLL",i.POLL_STATUS="POLL_STATUS",i.RANKING_PAGE_CHATTERS="RANKING_PAGE_CHATTERS",i.RANKING_PAGE_VIEWERS="RANKING_PAGE_VIEWERS"},{}],45:[function(e,t,n){Object.defineProperty(n,"__esModule",{value:!0}),n.computeUserAppURL=n.deserializeConf=void 0,n.deserializeConf=function(e,t){var n,i,o,r=(e=JSON.parse(e)).config.page_context;return(r=r&&r.query)&&("string"==typeof(o=r)||o instanceof String)&&(n=o=void 0,o=(i=r.match(/.*\/([igmsuy]+)$/))?(n=i[1],r.slice(1,-(n.length+1))):(n="",r.slice(1,-1)),e.config.page_context.query=new RegExp(o,n)),t&&"fn"===(null==(i=e.config.custom_auth)?void 0:i.jwt)&&(e.config.custom_auth.jwt=t.custom_auth.jwt),e},n.computeUserAppURL=function(e,t,n){var i=e+"#/"+t;return["site","lang","action","userId","siteKey","provider","wl","cm","bgColor","logo"].forEach(function(e,t){null!=n&&n[e]&&(i+=(t?"&":"?")+e+"="+encodeURIComponent(n[e]))}),i}},{}]},{},[16]);